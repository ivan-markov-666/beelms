# Тестове на "Интерактивна онлайн система за самостоятелно обучение"

В този документ ще намерите информация за различните тестове на системата, тяхното предназначение и как да ги изпълнявате.

## Тест на средата за разработка (`test-environment.ps1`)

### Предназначение

Този скрипт проверява дали локалната среда за разработка е правилно настроена, като тества:

- Наличието на Docker и Docker Compose
- Правилната работа на Docker демона
- Валидността на Docker Compose конфигурацията
- Способността за стартиране и комуникация с PostgreSQL и Redis контейнери
- Основни операции с базата данни и кеша

Скриптът е проектиран да работи както на Windows, така и на Linux системи, използващи PowerShell или PowerShell Core.

### Как да изпълните теста

#### На Windows:

1. Уверете се, че Docker Desktop е стартиран
2. Отворете PowerShell терминал (може да изисква админ права)
3. Разрешете изпълнението на скриптове (по подразбиране Windows има ограничения за сигурност):
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```
4. Навигирайте до папката на проекта
5. Изпълнете:
   ```powershell
   .\test-environment.ps1
   ```

#### На Linux (не е тествано дали работи):

1. Инсталирайте PowerShell Core, ако още не е инсталиран:

   ```bash
   # На Debian/Ubuntu
   sudo apt-get update
   sudo apt-get install -y wget apt-transport-https software-properties-common
   wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
   sudo dpkg -i packages-microsoft-prod.deb
   sudo apt-get update
   sudo apt-get install -y powershell
   ```

2. Направете скрипта изпълним:

   ```bash
   chmod +x test-environment.ps1
   ```

3. Изпълнете скрипта:
   ```bash
   ./test-environment.ps1
   # или
   pwsh test-environment.ps1
   ```

### Очаквани резултати

При успешно изпълнение, тестът ще покаже:

- ✅ Docker е инсталиран
- ✅ Docker Compose е инсталиран
- ✅ Docker работи
- ✅ Docker Compose конфигурацията е валидна
- ✅ Контейнерите са здрави и готови за работа
- ✅ PostgreSQL работи правилно
- ✅ Redis работи правилно
- ✅ Всички тестове преминаха успешно

### Диагностика при грешки

Ако възникне проблем, скриптът ще:

1. Покаже детайлно съобщение за грешка
2. Изведе логове от контейнерите (ако е приложимо)
3. Автоматично почисти тестовите контейнери
4. Предложи възможни решения

### Типични проблеми и решения

| Проблем                       | Решение                                                         |
| ----------------------------- | --------------------------------------------------------------- |
| Docker не работи              | Стартирайте Docker Desktop (Windows) или Docker service (Linux) |
| Грешка при конфигурацията     | Проверете синтаксиса на docker-compose.yml файловете            |
| Контейнерите не стават здрави | Прегледайте логовете за възможни проблеми с мрежата или правата |
| Проблем с PostgreSQL          | Проверете дали порт 5432 не е зает от друго приложение          |
| Проблем с Redis               | Проверете дали порт 6379 не е зает от друго приложение          |

## Тестове на миграциите на базата данни

### Предназначение

Тестовете на миграциите проверяват дали SQL скриптовете за миграция на базата данни работят правилно и могат да бъдат успешно приложени и върнати обратно. Това гарантира, че:

- Всички миграции се изпълняват без грешки
- Схемата на базата данни се създава правилно
- Миграциите могат да бъдат отменени (rolled back) при необходимост
- Индекси и ограничения се създават коректно

Тестовете използват отделна тестова база данни в Docker контейнер, за да не засягат разработката или продукционната среда.

### Налични миграционни тестове

Проектът включва следните миграционни тестове:

1. `CreateInitialSchema1683456789000` - Тества създаването на началната схема с всички таблици и връзки
2. `AddAdditionalIndices1683456789001` - Тества добавянето на допълнителни индекси за оптимизация на заявки

### Как да изпълните тестовете на миграциите

#### Използване на npm:

```bash
# Навигирайте до директорията с миграциите
cd db/migrations

# Изпълнете тестовете
npm test
```

#### Използване на Docker за тестване:

Можете да изпълните тестовете в изолирана Docker среда чрез следния скрипт:

```bash
# От основната директория на проекта
./db/scripts/run-docker-tests.sh
```

### Очаквани резултати

При успешно изпълнение, тестовете ще покажат:

```
PASS  tests/migrations.spec.ts
  Database Migrations
    ✓ should run migrations up successfully
    ✓ should run migrations down successfully
```

Допълнително, ще видите подробен лог на SQL заявките, изпълнени по време на теста.

### Диагностика при грешки

Ако срещнете проблеми с миграционните тестове:

1. **Проблеми с достъпа до тестовата база данни**:

   - Проверете дали тестовият Docker контейнер `test-db` е стартиран
   - Уверете се, че порт 5433 не е зает от друго приложение
   - Проверете дали настройките в `.env.test` са правилни

2. **Синтаксис грешки в SQL**:

   - Прегледайте внимателно логовете за конкретни SQL грешки
   - Коригирайте съответния миграционен файл

3. **Проблеми с PostgreSQL разширения**:
   - Някои миграции може да изискват специфични PostgreSQL разширения
   - Уверете се, че Docker образът включва необходимите разширения или модифицирайте миграциите да използват наличните функционалности (например, използвайте 'simple' вместо специфични езикови конфигурации за текстово търсене)

### Добавяне на нови миграции и тестове

За да добавите нова миграция:

```bash
cd db/migrations
npm run migration:create -- ИмеНаМиграцията
```

Новата миграция автоматично ще бъде включена в тестовете.

## Unit тестове

_Тази секция ще бъде добавена с напредването на проекта_

## Интеграционни тестове

_Тази секция ще бъде добавена с напредването на проекта_

## End-to-End тестове

_Тази секция ще бъде добавена с напредването на проекта_

## Тестове за сигурност

_Тази секция ще бъде добавена с напредването на проекта_
