# Тестове на "Интерактивна онлайн система за самостоятелно обучение"

В този документ ще намерите информация за различните тестове на системата, тяхното предназначение и как да ги изпълнявате.

## Съдържание

1. [Регресионно тестване](#регресионно-тестване)
2. [Тест на средата за разработка](#тест-на-средата-за-разработка-validate-docker-infrastructureps1)
3. [Тестове на миграциите на базата данни](#тестове-на-миграциите-на-базата-данни)
4. [Тестове на микросервисите](#тестове-на-микросервисите)
5. [Детайлни тестови сценарии](#детайлни-тестови-сценарии)

## Регресионно тестване

### Общ преглед

Регресионният тестов набор (`regression-suite.ps1`) е централизирано място за изпълнение на всички основни тестове на системата. Той включва:

- Тестове за валидиране на средата за разработка
- Тестове за базата данни и миграции
- Интеграционни тестове

### Как да използвате регресионния тестов набор

```powershell
# Изпълнете всички тестове
.\regression-suite.ps1

# Изпълнете конкретен тест
.\regression-suite.ps1 -TestName "TestDevelopmentEnvironment"

# Генерирайте HTML отчет
.\regression-suite.ps1 -GenerateReport
```

### Налични тестове

| Име на тест | Описание | Зависимости |
|-------------|----------|--------------|
| `TestDevelopmentEnvironment` | Валидира конфигурацията на средата за разработка | Docker, Docker Compose |
| `TestDatabaseMigrations` | Тества връзката с базата данни и зареждането на миграции | PostgreSQL, Redis |
| `TestAuthService` | Валидира процеса на автентикация и JWT токени | Keycloak, Redis |
| `TestUserService` | Тества CRUD операции за потребителски профили | PostgreSQL, Redis |
| `TestCourseService` | Проверява управлението на курсове и учебни модули | PostgreSQL, Elasticsearch |
| `TestTestService` | Валидира генерирането и изпълнението на тестове | PostgreSQL, Redis |
| `TestAnalyticsService` | Тества събирането и визуализацията на аналитични данни | PostgreSQL, Prometheus |
| `TestAdsService` | Проверява интеграцията с рекламни платформи | Google Ads API, Meta Ads API |

### Генериране на отчети

След изпълнение на тестовете, може да генерирате HTML отчет, който включва:

- Обобщение на резултатите от тестовете
- Детайли за всеки тест
- Време на изпълнение
- Грешки и предупреждения (ако има такива)

## Тест на средата за разработка (`validate-docker-infrastructure.ps1`)

Този тест е част от регресионния тестов набор и може да бъде изпълнен както самостоятелно, така и като част от цялостното тестване.

### Предназначение

Този скрипт проверява дали локалната среда за разработка е правилно настроена, като тества:

- Наличието на Docker и Docker Compose
- Правилната работа на Docker демона
- Валидността на Docker Compose конфигурацията
- Способността за стартиране и комуникация с PostgreSQL и Redis контейнери
- Основни операции с базата данни и кеша

Скриптът е проектиран да работи както на Windows, така и на Linux системи, използващи PowerShell или PowerShell Core.

### Как да изпълните теста

#### На Windows:

1. Уверете се, че Docker Desktop е стартиран
2. Отворете PowerShell терминал (може да изисква админ права)
3. Разрешете изпълнението на скриптове (по подразбиране Windows има ограничения за сигурност):
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```
4. Навигирайте до папката на проекта
5. Изпълнете:
   ```powershell
   .\validate-docker-infrastructure..ps1
   ```

#### На Linux (не е тествано дали работи):

1. Инсталирайте PowerShell Core, ако още не е инсталиран:

   ```bash
   # На Debian/Ubuntu
   sudo apt-get update
   sudo apt-get install -y wget apt-transport-https software-properties-common
   wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
   sudo dpkg -i packages-microsoft-prod.deb
   sudo apt-get update
   sudo apt-get install -y powershell
   ```

2. Направете скрипта изпълним:

   ```bash
   chmod +x validate-docker-infrastructure..ps1
   ```

3. Изпълнете скрипта:
   ```bash
   ./validate-docker-infrastructure..ps1
   # или
   pwsh validate-docker-infrastructure..ps1
   ```

### Очаквани резултати

При успешно изпълнение, тестът ще покаже:

- ✅ Docker е инсталиран
- ✅ Docker Compose е инсталиран
- ✅ Docker работи
- ✅ Docker Compose конфигурацията е валидна
- ✅ Контейнерите са здрави и готови за работа
- ✅ PostgreSQL работи правилно
- ✅ Redis работи правилно
- ✅ Всички тестове преминаха успешно

### Диагностика при грешки

Ако възникне проблем, скриптът ще:

1. Покаже детайлно съобщение за грешка
2. Изведе логове от контейнерите (ако е приложимо)
3. Автоматично почисти тестовите контейнери
4. Предложи възможни решения

### Типични проблеми и решения

| Проблем                       | Решение                                                         |
| ----------------------------- | --------------------------------------------------------------- |
| Docker не работи              | Стартирайте Docker Desktop (Windows) или Docker service (Linux) |
| Грешка при конфигурацията     | Проверете синтаксиса на docker-compose.yml файловете            |
| Контейнерите не стават здрави | Прегледайте логовете за възможни проблеми с мрежата или правата |
| Проблем с PostgreSQL          | Проверете дали порт 5432 не е зает от друго приложение          |
| Проблем с Redis               | Проверете дали порт 6379 не е зает от друго приложение          |

# Пълна обновена версия на секцията "Тестове на миграциите на базата данни"

````markdown
## Тестове на миграциите на базата данни

### Предназначение

Този тест фокусира вниманието си върху две ключови функционалности:

1. **Проверка на връзката с базата данни** - Тества дали е възможно да се осъществи успешна връзка с тестовата PostgreSQL база данни
2. **Зареждане на миграционни класове** - Проверява дали TypeORM може правилно да открие и зареди миграционните класове

За разлика от основните тестове на миграциите, този тест НЕ изпълнява самите миграции нагоре или надолу, а само валидира възможността за тяхното откриване и зареждане от TypeORM. Това е полезно за диагностика при проблеми с конфигурацията на TypeORM или с достъпа до базата данни.

### Налични миграционни тестове

Проектът включва следните миграционни тестове:

1. `CreateInitialSchema1683456789000` - Тества създаването на началната схема с всички таблици и връзки
2. `AddAdditionalIndices1683456789001` - Тества добавянето на допълнителни индекси за оптимизация на заявки

### Как да изпълните тестовете на миграциите

#### Използване на npm:

```bash
# Навигирайте до директорията с миграциите
cd db/migrations

# Изпълнете тестовете
npm test
```
````

#### Използване на Docker за тестване:

Можете да изпълните тестовете в изолирана Docker среда чрез следния скрипт:

```bash
# От основната директория на проекта
./db/scripts/run-docker-tests.sh
```

### Очаквани резултати

При успешно изпълнение, тестовете ще покажат:

```
PASS  tests/migrations.spec.ts
  Database Migrations
    ✓ should run migrations up successfully
    ✓ should run migrations down successfully
```

Допълнително, ще видите подробен лог на SQL заявките, изпълнени по време на теста.

### Диагностика при грешки

Ако срещнете проблеми с миграционните тестове:

1. **Проблеми с достъпа до тестовата база данни**:

   - Проверете дали тестовият Docker контейнер `test-db` е стартиран
   - Уверете се, че порт 5433 не е зает от друго приложение
   - Проверете дали настройките в `.env.test` са правилни

2. **Синтаксис грешки в SQL**:

   - Прегледайте внимателно логовете за конкретни SQL грешки
   - Коригирайте съответния миграционен файл

3. **Проблеми с PostgreSQL разширения**:
   - Някои миграции може да изискват специфични PostgreSQL разширения
   - Уверете се, че Docker образът включва необходимите разширения или модифицирайте миграциите да използват наличните функционалности (например, използвайте 'simple' вместо специфични езикови конфигурации за текстово търсене)

### Справяне с проблеми с отворени дръжки (Open Handles)

Когато тествате миграции с testcontainers, може да срещнете предупреждения за незатворени връзки. Ние сме адресирали този проблем с няколко техники:

1. **Използване на флага `--detectOpenHandles`**:

   ```bash
   npm test -- --detectOpenHandles
   ```

   или директно в package.json:

   ```json
   "test": "jest --config=jest.config.js --detectOpenHandles --forceExit"
   ```

2. **Подобрено затваряне на ресурсите**:

   - Добавяне на изчакване между затваряне на връзката с базата данни и спиране на контейнера
   - Експлицитно затваряне на PostgreSQL пулове
   - Оптимизирани настройки за по-бързо освобождаване на неактивни връзки

3. **Оптимизирани настройки на PostgreSQL контейнера**:

   ```typescript
   .withCommand([
     'postgres',
     '-c', 'max_connections=100',
     '-c', 'shared_buffers=256MB',
     '-c', 'log_statement=all',
     '-c', 'idle_in_transaction_session_timeout=5000' // За по-бързо затваряне на неактивни транзакции
   ])
   ```

4. **Настройки на връзката с базата данни**:

   ```typescript
   dataSource = new DataSource({
     // Основни настройки...
     extra: {
       connectionTimeoutMillis: 60000,
       max: 5,
       idle_in_transaction_session_timeout: 5000,
       statement_timeout: 10000,
       pool: {
         idleTimeoutMillis: 1000,
         max: 5,
         allowExitOnIdle: true, // Ключово за чисто приключване на тестовете
       },
     },
   });
   ```

5. **Правилно използване на API на `testcontainers`**:
   - За по-новите версии на testcontainers, използвайте `Wait.forListeningPorts()` без аргументи
   - Включете допълнително изчакване след стартиране на контейнера
   ```typescript
   .withWaitStrategy(
     Wait.forAll([
       Wait.forLogMessage(/database system is ready to accept connections/),
       Wait.forListeningPorts()
     ])
   )
   ```

Тези подобрения осигуряват стабилно изпълнение на тестовете без предупреждения за незатворени връзки или процеси.

### Добавяне на нови миграции и тестове

За да добавите нова миграция:

```bash
cd db/migrations
npm run migration:create -- ИмеНаМиграцията
```

Новата миграция автоматично ще бъде включена в тестовете.

### Тест за зареждане на миграции и връзка с базата данни (`db-migration-connection-test.ts`)

#### Предназначение

Този тест фокусира вниманието си върху две ключови функционалности:

1. **Проверка на връзката с базата данни** - Тества дали е възможно да се осъществи успешна връзка с тестовата PostgreSQL база данни
2. **Зареждане на миграционни класове** - Проверява дали TypeORM може правилно да открие и зареди миграционните класове

За разлика от основните тестове на миграциите, този тест НЕ изпълнява самите миграции нагоре или надолу, а само валидира възможността за тяхното откриване и зареждане от TypeORM. Това е полезно за диагностика при проблеми с конфигурацията на TypeORM или с достъпа до базата данни.

#### Как да изпълните теста

```bash
# Навигирайте до директорията с миграциите
cd db/migrations

# Изпълнете теста директно с ts-node
npx ts-node tests/db-migration-connection-test.ts
```

### Използване на специализирания скрипт за тестване (`run-migrations-tests.sh`)

#### Предназначение

Този скрипт осигурява бърз и директен начин за стартиране на тестовете на миграциите без необходимост от допълнителна конфигурация. За разлика от `run-docker-tests.sh`, този скрипт:

- Изпълнява тестовете директно в текущата среда (без Docker)
- Използва съществуващата конфигурация и настройки
- Предоставя прост интерфейс с минимални изисквания за настройка

Скриптът е особено полезен при:

- Бързи проверки на миграциите
- Когато Docker не е наличен или не е необходим
- Интеграция с CI/CD процеси, които контролират собствена среда

#### Как да изпълните скрипта

```bash
# От основната директория на проекта
./db/scripts/run-migrations-tests.sh

# Или от директорията на скриптовете
cd db/scripts
./run-migrations-tests.sh
```

## Тестове на микросервисите

### Тестове на микросервисите

| Име на тест | Предназначение | Зависимости |
|-------------|-----------------|--------------|
| `TestAuthService` | Валидира процеса на автентикация и JWT токени | Keycloak, Redis |
| `auth-health.test.ps1` | Проверява здравословното състояние на услугата | Keycloak, Redis |
| `auth-integration.test.ps1` | Интеграционни тестове за автентикация и авторизация | Keycloak, Redis |
| `TestUserService` | Тества CRUD операции за потребителски профили | PostgreSQL, Redis |
| `TestCourseService` | Проверява управлението на курсове и учебни модули | PostgreSQL, Elasticsearch |
| `TestTestService` | Валидира генерирането и изпълнението на тестове | PostgreSQL, Redis |
| `TestAnalyticsService` | Тества събирането и визуализацията на аналитични данни | PostgreSQL, Prometheus |
| `TestAdsService` | Проверява интеграцията с рекламни платформи | Google Ads API, Meta Ads API |

**Пример за изпълнение:**
```powershell
./regression-suite.ps1 -TestName TestAuthService
```

## Unit тестове

_Тази секция ще бъде добавена с напредването на проекта_

## Интеграционни тестове

_Тази секция ще бъде добавена с напредването на проекта_

## End-to-End тестове

_Тази секция ще бъде добавена с напредването на проекта_

## Тестове за сигурност

_Тази секция ще бъде добавена с напредването на проекта_
