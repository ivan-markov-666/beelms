#!/bin/bash
set -e
echo "üöÄ –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ Docker —Å—Ä–µ–¥–∞—Ç–∞..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç–µ—â–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏—Ç–µ..."
if ! docker-compose ps | grep -q "Up"; then
  echo "‚ùå –ì—Ä–µ—à–∫–∞: –ù–µ –≤—Å–∏—á–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ —Å–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–∏"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ PostgreSQL
echo "üõ¢Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å PostgreSQL..."
if ! docker-compose exec -T postgres pg_isready -U postgres; then
  echo "‚ùå –ì—Ä–µ—à–∫–∞: –ù–µ—É—Å–ø–µ—à–Ω–∞ –≤—Ä—ä–∑–∫–∞ —Å PostgreSQL"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ API —Å—ä—Ä–≤–∏—Å–∞ (—Å –∫—Ä–∞—Ç—ä–∫ —Ç–∞–π–º–∞—É—Ç –≤ —Å–ª—É—á–∞–π —á–µ –æ—â–µ –Ω–µ –µ –≥–æ—Ç–æ–≤)
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ API —Å—ä—Ä–≤–∏—Å–∞..."
API_STATUS=$(curl -s --max-time 5 -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "000")
if [ "$API_STATUS" != "200" ]; then
  echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: API —Å—ä—Ä–≤–∏—Å—ä—Ç –Ω–µ –æ—Ç–≥–æ–≤–∞—Ä—è (–û—á–∞–∫–≤–∞ —Å–µ 200, –ø–æ–ª—É—á–µ–Ω $API_STATUS)"
  echo "   –¢–æ–≤–∞ –º–æ–∂–µ –¥–∞ –µ –Ω–æ—Ä–º–∞–ª–Ω–æ, –∞–∫–æ API —Å—ä—Ä–≤–∏—Å—ä—Ç –≤—Å–µ –æ—â–µ –Ω–µ –µ –Ω–∞–ø—ä–ª–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω."
  echo "   –£–≤–µ—Ä–µ—Ç–µ —Å–µ, —á–µ API —Å—ä—Ä–≤–∏—Å—ä—Ç –∏–º–∞ endpoint /health"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ç–∞ (—Å–∞–º–æ –¥–∞–ª–∏ –ø–æ—Ä—Ç–æ–≤–µ—Ç–µ —Å–∞ –æ—Ç–≤–æ—Ä–µ–Ω–∏)
echo "üñ•Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ä—Ç–æ–≤–µ—Ç–µ –Ω–∞ —É–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ç–∞..."
if nc -z localhost 3001 >/dev/null 2>&1; then
  echo "‚úÖ –ü—É–±–ª–∏—á–Ω–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑–≥–ª–µ–∂–¥–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç 3001"
else
  echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ü—É–±–ª–∏—á–Ω–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–∑–≥–ª–µ–∂–¥–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç 3001"
  echo "   –¢–æ–≤–∞ –º–æ–∂–µ –¥–∞ –µ –Ω–æ—Ä–º–∞–ª–Ω–æ, –∞–∫–æ —É–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –≤—Å–µ –æ—â–µ –Ω–µ –µ –Ω–∞–ø—ä–ª–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–æ."
fi

if nc -z localhost 3002 >/dev/null 2>&1; then
  echo "‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑–≥–ª–µ–∂–¥–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç 3002"
else
  echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏–∑–≥–ª–µ–∂–¥–∞ –¥–æ—Å—Ç—ä–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç 3002"
  echo "   –¢–æ–≤–∞ –º–æ–∂–µ –¥–∞ –µ –Ω–æ—Ä–º–∞–ª–Ω–æ, –∞–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –æ—â–µ –Ω–µ –µ –Ω–∞–ø—ä–ª–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–Ω–æ."
fi

echo ""
echo "‚úÖ –í–∞–ª–∏–¥–∏—Ä–∞–Ω–µ—Ç–æ –ø—Ä–∏–∫–ª—é—á–∏!"
echo ""
echo "–î–æ—Å—Ç—ä–ø –¥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ç–∞:"
echo "   - –ü—É–±–ª–∏—á–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: http://localhost:3001"
echo "   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: http://localhost:3002"
echo "   - API: http://localhost:3000"
echo "   - pgAdmin: http://localhost:5050"
echo ""
echo "–ó–∞ –ø–æ–≤–µ—á–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∏–∂—Ç–µ TESTS.md"
