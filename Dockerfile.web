FROM node:18-alpine AS development

WORKDIR /app

# Install system dependencies
RUN apk add --no-cache python3 make g++ git curl

# Install pnpm globally
RUN npm install -g pnpm

# Create necessary directories
RUN mkdir -p ./apps/web/public ./apps/web/src ./packages

# Copy workspace configuration files
COPY package.json pnpm-workspace.yaml ./
COPY pnpm-lock.yaml* ./

# Create minimal web package.json
RUN echo '{"name":"@qa-platform/web","version":"0.0.1","scripts":{"dev":"vite"},"dependencies":{"react":"^18.2.0","react-dom":"^18.2.0"},"devDependencies":{"vite":"^4.0.0"}}' > ./apps/web/package.json

# Install dependencies separately
RUN pnpm install --frozen-lockfile || echo "Continuing with installation errors"

# Create minimal web app files
RUN echo 'import React from "react"; \
const App = () => <div>Web App is running!</div>; \
const root = document.getElementById("root"); \
if (root) { \
  import("react-dom").then(ReactDOM => { \
    ReactDOM.render(<App />, root); \
  }); \
} \
' > ./apps/web/src/index.jsx

RUN echo '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>QA Platform</title>\n</head>\n<body>\n  <div id="root"></div>\n  <script type="module" src="/src/index.jsx"></script>\n</body>\n</html>' > ./apps/web/public/index.html

RUN echo '{ "compilerOptions": { "target": "ES2020", "useDefineForClassFields": true, "lib": ["ES2020", "DOM", "DOM.Iterable"], "module": "ESNext", "skipLibCheck": true, "moduleResolution": "bundler", "allowImportingTsExtensions": true, "resolveJsonModule": true, "isolatedModules": true, "noEmit": true, "jsx": "react-jsx", "strict": true, "noUnusedLocals": true, "noUnusedParameters": true, "noFallthroughCasesInSwitch": true }, "include": ["src"], "references": [{ "path": "./tsconfig.node.json" }] }' > ./apps/web/tsconfig.json

RUN echo '{ "compilerOptions": { "composite": true, "skipLibCheck": true, "module": "ESNext", "moduleResolution": "bundler", "allowSyntheticDefaultImports": true }, "include": ["vite.config.js"] }' > ./apps/web/tsconfig.node.json

RUN echo 'import { defineConfig } from "vite"; \nexport default defineConfig({ plugins: [], server: { port: 3000, host: "0.0.0.0" } });' > ./apps/web/vite.config.js

# Expose the port the app runs on
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000 || exit 1

# Command to run the application in development mode
CMD ["pnpm", "--filter", "@qa-platform/web", "run", "dev"]
