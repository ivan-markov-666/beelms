openapi: 3.1.0
info:
  title: beelms API
  version: 0.1.0
  description: |
    OpenAPI спецификация за основните MVP услуги на beelms.

servers:
  - url: https://api.example.com/api
    description: Production (примерен домейн, с /api префикс)
  - url: http://localhost:3000/api
    description: Local development (с /api префикс)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
        details:
          type: object
          additionalProperties: true

    AuthToken:
      type: object
      properties:
        accessToken:
          type: string
        tokenType:
          type: string
          example: Bearer

    UserProfile:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        role:
          type: string
          description: Роля на потребителя (напр. "user", "admin", "teacher", "author", "monitoring")
        emailChangeLimitReached:
          type: boolean
          description: Дали е достигнат лимитът за потвърждения на смяна на email в текущия прозорец
        emailChangeLimitResetAt:
          type: string
          format: date-time
          nullable: true
          description: ISO дата/час, когато лимитът за смяна на email се нулира (ако е приложимо)

    UserExport:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        active:
          type: boolean

    AdminUserSummary:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          description: Роля на потребителя (напр. "user", "admin")
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time

    WikiArticle:
      type: object
      properties:
        id:
          type: string
        slug:
          type: string
        language:
          type: string
          example: bg
        title:
          type: string
        content:
          type: string
        status:
          type: string
          description: Статус на статията (draft, active, inactive)
          enum: [draft, active, inactive]
        updatedAt:
          type: string
          format: date-time

    WikiArticleInput:
      type: object
      properties:
        slug:
          type: string
          description: Уникален идентификатор/част от URL-а за статията
        language:
          type: string
          example: bg
        title:
          type: string
        content:
          type: string
        status:
          type: string
          description: Статус на статията при създаване/редакция (draft, active, inactive)
          enum: [draft, active, inactive]
      required: [language, title, content]

    WikiArticleVersion:
      type: object
      properties:
        id:
          type: string
        articleId:
          type: string
        version:
          type: integer
        language:
          type: string
        title:
          type: string
        content:
          type: string
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
          description: Идентификатор на потребителя, направил промяната

    AdminWikiArticleListItem:
      type: object
      properties:
        id:
          type: string
        slug:
          type: string
        title:
          type: string
        status:
          type: string
          description: Статус на статията (draft, active, inactive)
          enum: [draft, active, inactive]
        updatedAt:
          type: string
          format: date-time

    AdminWikiArticleCreateInput:
      type: object
      properties:
        slug:
          type: string
          description: Уникален идентификатор/част от URL-а за статията
        status:
          type: string
          description: Начален статус на статията (draft, active, inactive)
          enum: [draft, active, inactive]
        contents:
          type: array
          minItems: 1
          description: Списък с локализирани версии (език, заглавие, съдържание)
          items:
            type: object
            properties:
              language:
                type: string
                example: bg
              title:
                type: string
              content:
                type: string
            required: [language, title, content]
      required: [slug, status, contents]

    AdminWikiArticleUpdateInput:
      type: object
      properties:
        language:
          type: string
          example: bg
        title:
          type: string
        content:
          type: string
        status:
          type: string
          description: Нов статус на статията (draft, active, inactive)
          enum: [draft, active, inactive]
      required: [language, title, content, status]

    AdminUpdateWikiStatusInput:
      type: object
      properties:
        status:
          type: string
          description: Нов статус на статията (draft, active, inactive)
          enum: [draft, active, inactive]
      required: [status]

    AdminWikiArticleVersion:
      type: object
      properties:
        id:
          type: string
        version:
          type: integer
        language:
          type: string
        title:
          type: string
        createdAt:
          type: string
          format: date-time
        createdBy:
          type: string
          nullable: true
          description: Идентификатор на потребителя, направил промяната

    MetricsOverview:
      type: object
      properties:
        totalUsers:
          type: integer
        totalArticles:
          type: integer
        topArticles:
          type: array
          items:
            type: object
            properties:
              slug:
                type: string
        usersChangePercentSinceLastMonth:
          type: number
          format: float
          nullable: true
          description: >-
            Процент промяна на общия брой потребители спрямо броя им в края на
            предходния календарен месец.

    WikiMediaItem:
      type: object
      properties:
        filename:
          type: string
          description: Име на файла, уникално в рамките на статията
        url:
          type: string
          description: Пълен URL за достъп до изображението (използва се в markdown съдържанието)

    CourseSummary:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        language:
          type: string
          example: bg
        status:
          type: string
          description: Статус на курса (draft, active, inactive)
          enum: [draft, active, inactive]

    CourseModuleItem:
      type: object
      properties:
        id:
          type: string
        itemType:
          type: string
          description: Тип на елемента в програмата на курса
          enum: [wiki, task, quiz]
        title:
          type: string
        order:
          type: integer
        wikiSlug:
          type: string
          nullable: true
        taskId:
          type: string
          nullable: true
        quizId:
          type: string
          nullable: true

    CourseDetail:
      allOf:
        - $ref: '#/components/schemas/CourseSummary'
        - type: object
          properties:
            curriculum:
              type: array
              items:
                $ref: '#/components/schemas/CourseModuleItem'

    MyCourseListItem:
      allOf:
        - $ref: '#/components/schemas/CourseSummary'
        - type: object
          properties:
            enrollmentStatus:
              type: string
              enum: [not_started, in_progress, completed]
            progressPercent:
              type: number
              format: float
              nullable: true
            enrolledAt:
              type: string
              format: date-time
              nullable: true

    Task:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string

    Quiz:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        passingScore:
          type: integer
          nullable: true
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuizQuestion'

    QuizQuestion:
      type: object
      properties:
        id:
          type: string
        text:
          type: string
        options:
          type: array
          items:
            type: string

    QuizSubmitInput:
      type: object
      properties:
        answers:
          type: array
          items:
            type: object
            properties:
              questionId:
                type: string
              optionIndex:
                type: integer
            required: [questionId, optionIndex]
      required: [answers]

    QuizSubmitResult:
      type: object
      properties:
        score:
          type: integer
        maxScore:
          type: integer
        passed:
          type: boolean

security:
  - bearerAuth: []

paths:
  ############################
  # Auth Service
  ############################

  /auth/register:
    post:
      tags: [Auth]
      summary: Регистрация на нов потребител
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required: [email, password]
      responses:
        "201":
          description: Успешна регистрация
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        "400":
          description: Невалидни данни
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags: [Auth]
      summary: Вход на потребител
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required: [email, password]
      responses:
        "200":
          description: Успешен вход
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthToken'
        "401":
          description: Невалидни идентификационни данни
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/forgot-password:
    post:
      tags: [Auth]
      summary: Заявка за смяна на забравена парола
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
              required: [email]
      responses:
        "200":
          description: Имейл с инструкции е изпратен (ако адресът съществува)
        "400":
          description: Невалидни данни

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: Смяна на парола чрез токен
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                newPassword:
                  type: string
              required: [token, newPassword]
      responses:
        "200":
          description: Паролата е сменена успешно
        "400":
          description: Невалиден или изтекъл токен

  /auth/verify-email:
    post:
      tags: [Auth]
      summary: Потвърждение на имейл чрез verification токен
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
              required: [token]
      responses:
        "200":
          description: Имейлът е потвърден успешно (регистрация или смяна на имейл)
        "400":
          description: Невалиден или изтекъл verification токен

  /users/me:
    get:
      tags: [Account]
      summary: Връща профилна информация за текущия потребител
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Профил на текущия потребител
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        "401":
          description: Неоторизиран достъп

    patch:
      tags: [Account]
      summary: Обновяване на профилна информация на текущия потребител
      description: |
        MVP: позволява промяна на имейл адреса.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
              required: [email]
      responses:
        "200":
          description: Профилът е обновен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        "400":
          description: Невалидни данни
        "401":
          description: Неоторизиран достъп

    delete:
      tags: [Account]
      summary: Деактивиране/изтриване на акаунт на текущия потребител
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Акаунтът е деактивиран
        "401":
          description: Неоторизиран достъп

  /users/me/export:
    post:
      tags: [Account]
      summary: Заявка за експорт на лични данни (GDPR)
      description: |
        Връща JSON payload с основните лични данни (MVP).
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                captchaToken:
                  type: string
              required: []
      responses:
        "200":
          description: Експортът е генериран
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserExport'
        "400":
          description: Невалидни данни (например липсващ captchaToken, когато е задължителен)
        "401":
          description: Неоторизиран достъп

  /users/me/change-password:
    post:
      tags: [Account]
      summary: Смяна на парола на текущия потребител
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                currentPassword:
                  type: string
                newPassword:
                  type: string
              required: [currentPassword, newPassword]
      responses:
        "204":
          description: Паролата е сменена успешно
        "400":
          description: Невалидни данни
        "401":
          description: Неоторизиран достъп

  /users/me/courses:
    get:
      tags: [Courses]
      summary: Списък с курсове за текущия потребител (My Courses)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Списък с курсове + базов прогрес
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MyCourseListItem'
        "401":
          description: Неоторизиран достъп

  ############################
  # Courses & Assessments
  ############################

  /courses:
    get:
      tags: [Courses]
      summary: Списък с курсове (catalog)
      security: []
      responses:
        "200":
          description: Списък с курсове
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CourseSummary'

  /courses/{courseId}:
    get:
      tags: [Courses]
      summary: Детайл на курс
      security: []
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Детайл на курс
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseDetail'
        "404":
          description: Курсът не е намерен

  /courses/{courseId}/enroll:
    post:
      tags: [Courses]
      summary: Записване (enroll) в курс
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Потребителят е записан успешно
        "401":
          description: Неоторизиран достъп
        "404":
          description: Курсът не е намерен

  /courses/{courseId}/tasks/{taskId}/complete:
    post:
      tags: [Courses]
      summary: Маркиране на задача като изпълнена (completed)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
        - in: path
          name: taskId
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Задачата е маркирана като изпълнена
        "401":
          description: Неоторизиран достъп
        "404":
          description: Курсът или задачата не са намерени

  /courses/{courseId}/quizzes/{quizId}:
    get:
      tags: [Assessments]
      summary: Зареждане на quiz
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
        - in: path
          name: quizId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Quiz за попълване
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        "401":
          description: Неоторизиран достъп
        "404":
          description: Курсът или quiz-ът не са намерени

  /courses/{courseId}/quizzes/{quizId}/submit:
    post:
      tags: [Assessments]
      summary: Submit на quiz отговори и връщане на резултат
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
        - in: path
          name: quizId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizSubmitInput'
      responses:
        "200":
          description: Резултат от quiz attempt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuizSubmitResult'
        "400":
          description: Невалидни данни
        "401":
          description: Неоторизиран достъп
        "404":
          description: Курсът или quiz-ът не са намерени

  /admin/users:
    get:
      tags: [Admin]
      summary: Списък с потребители
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Търсене по имейл
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: Номер на страницата (за странициране на списъка)
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
          description: Брой потребители на страница
      responses:
        "200":
          description: Списък с потребители
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdminUserSummary'
        "401":
          description: Неоторизиран достъп

  /admin/users/{id}:
    patch:
      tags: [Admin]
      summary: Активиране/деактивиране на потребителски акаунт
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                active:
                  type: boolean
              required: [active]
      responses:
        "200":
          description: Обновен потребител
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUserSummary'
        "401":
          description: Неоторизиран достъп
        "404":
          description: Потребителят не е намерен

  ############################
  # Wiki Service
  ############################

  /wiki/articles:
    get:
      tags: [Wiki]
      summary: Списък с Wiki статии
      security: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Търсене по заглавие/ключова дума
        - in: query
          name: lang
          schema:
            type: string
          description: Код на езика (напр. bg, en)
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Списък със статии
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WikiArticle'

  /wiki/articles/{slug}:
    get:
      tags: [Wiki]
      summary: Връща една Wiki статия по slug
      security: []
      parameters:
        - in: path
          name: slug
          required: true
          schema:
            type: string
        - in: query
          name: lang
          schema:
            type: string
          description: Код на езика (ако не е зададен, използва се по подразбиране)
      responses:
        "200":
          description: Успешно
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WikiArticle'
        "404":
          description: Статията не е намерена

  ############################
  # Admin Wiki (CRUD + версии)
  ############################

  /admin/wiki/articles:
    get:
      tags: [Admin, Wiki]
      summary: Списък с Wiki статии за администрация
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Търсене по заглавие/slug
        - in: query
          name: lang
          schema:
            type: string
          description: Код на езика (напр. bg, en)
      responses:
        "200":
          description: Списък със статии
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdminWikiArticleListItem'
        "401":
          description: Неоторизиран достъп

    post:
      tags: [Admin, Wiki]
      summary: Създаване на нова Wiki статия
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminWikiArticleCreateInput'
      responses:
        "201":
          description: Статията е създадена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WikiArticle'
        "400":
          description: Невалидни данни
        "401":
          description: Неоторизиран достъп

  /admin/wiki/articles/{id}:
    put:
      tags: [Admin, Wiki]
      summary: Редакция на съществуваща Wiki статия
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WikiArticleInput'
      responses:
        "200":
          description: Обновена статия
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WikiArticle'
        "400":
          description: Невалидни данни
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията не е намерена

  /admin/wiki/articles/{id}/status:
    patch:
      tags: [Admin, Wiki]
      summary: Промяна на статуса на Wiki статия (draft/active/inactive)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminUpdateWikiStatusInput'
      responses:
        "204":
          description: Статусът е обновен успешно
        "400":
          description: Невалидни данни
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията не е намерена

  /admin/wiki/articles/{id}/versions:
    get:
      tags: [Admin, Wiki]
      summary: История на версиите за дадена Wiki статия
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Списък с версии
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdminWikiArticleVersion'
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията не е намерена

  /admin/wiki/articles/{id}/versions/{versionId}/restore:
    post:
      tags: [Admin, Wiki]
      summary: Връщане към избрана версия на Wiki статия (rollback)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: path
          name: versionId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Текущата версия е върната към избраната историческа версия
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WikiArticle'
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията или версията не са намерени

  /admin/wiki/articles/{id}/versions/{versionId}:
    delete:
      tags: [Admin, Wiki]
      summary: Изтриване на избрана версия на Wiki статия (без да се засяга текущата)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: path
          name: versionId
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Версията е изтрита
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията или версията не са намерени

  /admin/wiki/articles/{id}/media:
    get:
      tags: [Admin, Wiki]
      summary: Списък с изображения (media) за дадена Wiki статия
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Списък с изображения, асоциирани със статията
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WikiMediaItem'
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията не е намерена

    post:
      tags: [Admin, Wiki]
      summary: Качване на ново изображение (media) за дадена Wiki статия
      description: |
        Качва един файл (изображение), който впоследствие може да бъде рефериран от markdown съдържанието на статията.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required: [file]
      responses:
        "201":
          description: Файлът е качен успешно
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WikiMediaItem'
        "400":
          description: Невалидни данни (липсващ или неподдържан файл)
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията не е намерена

  /admin/wiki/articles/{id}/media/{filename}:
    delete:
      tags: [Admin, Wiki]
      summary: Изтриване на изображение, асоциирано с дадена Wiki статия
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - in: path
          name: filename
          required: true
          schema:
            type: string
          description: Име на файла, което ще бъде изтрито за тази статия
      responses:
        "204":
          description: Файлът е изтрит
        "401":
          description: Неоторизиран достъп
        "404":
          description: Статията или файлът не са намерени

  ############################
  # Admin / Metrics (MVP ниво)
  ############################

  /admin/metrics/overview:
    get:
      tags: [Admin]
      summary: Базов преглед на метрики за администраторски табло
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Преглед на основни метрики
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsOverview'
        "401":
          description: Неоторизиран достъп
