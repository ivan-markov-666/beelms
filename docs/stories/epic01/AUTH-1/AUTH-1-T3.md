# AUTH-1-T3: Регистрационен ендпойнт

## Описание
Имплементация на ендпойнт за регистрация на нови потребители с валидация, i18n и observability.

## API Ендпойнт

### POST /api/v1/auth/register

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "firstName": "John",
  "lastName": "Doe",
  "acceptTerms": true
}
```

**Валидации:**
- `email`: Валиден имейл формат, максимална дължина 255 символа
- `password`: Минимум 12 символа, поне една главна буква, една малка буква, една цифра и един специален символ
- `firstName`: Не може да е празно, максимум 100 символа
- `lastName`: Не може да е празно, максимум 100 символа
- `acceptTerms`: Задължително трябва да е `true`

**Security:**
- Rate limiting: 5 заявки на IP за 15 минути
- Защита срещу автоматични регистрации (reCAPTCHA v3)

**Headers:**
- `Accept-Language`: `bg` (опционален, по подразбиране: `bg`)
- `X-Request-ID`: `uuid-v4` (за проследяване на заявките)

**Responses:**
- `202 Accepted`: Успешна заявка за регистрация
  - Headers:
    - `Location`: `/auth/verification-pending`
    - `Retry-After`: 60 (в секунди до изтичане на токена за потвърждение)
  - Body:
  ```json
  {
    "message": "Verification email sent",
    "expiresIn": 3600,
    "email": "use***@example.com"
  }
  ```

- `400 Bad Request`: Невалидни входни данни
  ```json
  {
    "statusCode": 400,
    "error": "Bad Request",
    "message": [
      {
        "property": "email",
        "constraints": {
          "isEmail": "Имейл адресът е невалиден"
        }
      },
      {
        "property": "password",
        "constraints": {
          "minLength": "Паролата трябва да бъде поне 12 символа",
          "matches": "Паролата трябва да съдържа поне една главна буква, една малка буква, една цифра и един специален символ"
        }
      }
    ],
    "requestId": "req_1234567890"
  }
  ```

- `409 Conflict`: Имейлът вече е регистриран
  ```json
  {
    "statusCode": 409,
    "error": "Conflict",
    "message": "Имейл адресът вече е регистриран. Ако не можете да влезете, използвайте функцията за забравена парола.",
    "code": "EMAIL_ALREADY_EXISTS",
    "requestId": "req_1234567890"
    "message": "Email already registered"
  }
  ```

## Изисквания

### Валидация
- Валидиране на имейл адрес (RFC 5322)
- Валидиране на парола (минимум 12 символа, големи/малки букви, цифри, специални символи)
- Проверка за дублирани имейли
- Валидация според GDPR изисквания

### Сигурност
- Rate limiting: 5 заявки/час на IP
- Криптиране на чувствителни данни преди съхранение
- Няма чувствителни данни в логовете
- Защита срещу CSRF
- Валидация на входните данни срещу XSS/инжекции

### Observability
- Метрики:
  - `auth_registration_attempts_total{status="success|error"}`
  - `auth_registration_duration_seconds` (хистограма)
  - `rate_limit_hits_total{path, status_code}`

- Логове (структурирани JSON):
  - Всички опити за регистрация с метаданни
  - Грешки с контекст и stack traces

- Трейсове:
  - End-to-end проследяване на заявките
  - Време за изпълнение на всеки етап

## Изпълнение
1. Валидиране на входните данни
2. Проверка за съществуващ потребител
3. Хеширане на паролата
4. Създаване на потребителски запис със статус 'pending_verification'
5. Генериране на верификационен токен
6. Изпращане на имейл за потвърждение
7. Връщане на успешен отговор

## Допълнителни бележки

### Сигурност:
- Всички пароли се хешират с Argon2id преди запис в базата
- Изпраща се имейл за потвърждение с линк, който изтича след 1 час
- Линковете за потвърждение са еднократни и стават невалидни след употреба
- Всички грешки се логват без чувствителна информация

### Поведение при съществуващ акаунт:
- При опит за регистрация с вече регистриран имейл:
  - Ако имейлът не е потвърден: изпраща се нов имейл за потвърждение
  - Ако имейлът е потвърден: връща се грешка 409 Conflict

### Логика за изпращане на имейл:
1. Генерира се уникален токен за потвърждение
2. Записва се в базата с тип 'email_verification'
3. Изпраща се имейл с линк за потвърждение
4. При кликване на линка, токенът се валидира и акаунтът се активира

### Метрики и мониторинг:
- Проследяване на успешни регистрации
- Проследяване на неуспешни опити за регистрация
- Мониторинг на времето за изпълнение на заявката
- Следене на грешки и изключения

## Критерии за приемане
- [ ] Всички тестове минават успешно
- [ ] Покритие на кода ≥ 90%
- [ ] Документиран API в Swagger
- [ ] Имплементирани са всички валидации
- [ ] Налични са метрики и логове
- [ ] Интеграция със Sentry за грешки

## Зависимости
- [AUTH-1-T2](AUTH-1-T2.md)
- [AUTH-1-T4](AUTH-1-T4.md)
- [AUTH-1-T5](AUTH-1-T5.md)

## Свързани файлове
- `src/auth/controllers/auth.controller.ts`
- `src/auth/dto/register.dto.ts`
- `src/auth/services/registration.service.ts`
- `test/auth/registration.e2e-spec.ts`
