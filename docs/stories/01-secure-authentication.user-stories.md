# User Stories – Epic 01: Secure Authentication

Този документ агрегира всички user story-та, дефинирани за епика **„Сигурна автентикация и управление на потребители“** (`docs/epics/01-secure-authentication.md`). Използвайте го за планиране на спрингтове, traceability и проследяване на прогреса.

| ID | User Story | Acceptance Criteria (Definition of Done) |
|----|------------|------------------------------------------|
| AUTH-1 | **Като гост** искам да се регистрирам само с имейл и парола, за да получа достъп до системата. | • `POST /registration` връща **201**<br>• Имейлът е изпратен с токен за потвърждение<br>• Новият потребител получава роля `student` |
| AUTH-2 | **Като новорегистриран потребител** искам да потвърдя имейла си, за да активирам акаунта си. | • `GET /verify-email?token=XYZ` активира акаунта<br>• Потвърден потребител може да влиза |
| AUTH-3 | **Като студент/администратор** искам да влизам с имейл и парола, за да използвам LMS. | • `POST /login` връща JWT access (15 min) + refresh (7 days) в **HttpOnly cookies**<br>• 95-ти персентил време ≤ **300 ms** |
| AUTH-4 | **Като потребител** искам автоматично подновяване на сесията чрез refresh токен, за да не излизам често. | • `POST /refresh` връща нов access токен<br>• Изтекли/ревокирани refresh токени се откриват |
| AUTH-5 | **Като потребител**, забравил паролата си, искам имейл за възстановяване, за да си възстановя достъпа. | • `POST /forgot-password` изпраща токен (TTL ≤ **30 min**)<br>• `POST /reset-password` променя паролата и инвалидира старите токени |
| AUTH-6 | **Като система** искам да валидирам силата на паролите, за да предотвратя слаби или изтекли пароли. | • Пароли < 8 символа или „pwned“ в HIBP → **400**<br>• `zxcvbn` score ≥ **3** |
| AUTH-7 | **Като администратор** искам RBAC, за да ограничавам достъпа според роли (`admin`, `student`). | • NestJS Guard отказва **403** при несъответствие<br>• Интеграционни тестове за всяка защитена пътека |
| AUTH-8 | **Като DevOps** искам seed скрипт за създаване на първи `admin`, за да избегна публичен endpoint. | • `npm run seed:admin` създава админ в БД<br>• Скриптът е идемпотентен |
| AUTH-9 | **Като SecOps** искам логове за успешни и неуспешни опити за вход, за да откривам злоупотреби. | • IP, User-Agent и userId се логват в Sentry + stdout<br>• Логовете са структурирани (JSON) |
| AUTH-10 | **Като система** искам rate-limiting на auth endpoint-ите, за да предотвратя brute-force атаки. | • > 5 опита / мин → **429** + `Retry-After`<br>• Конфигурируем праг |
| AUTH-11 | **Като потребител** искам да изтрия акаунта си (GDPR Art. 17), за да контролирам личните си данни. | • `DELETE /me` изисква email-confirmation токен<br>• Данните се заличават ≤ **30 дни** |
| AUTH-12 | **Като разработчик** искам OpenAPI спецификация на всички auth маршрути, за да гарантирам ясно API. | • `swagger.json`/`yaml` се генерира в CI<br>• Всички полета имат описания и примери |

---
### Общи бележки
1. **Definition of Done (global):** ≥ 90 % unit/integration тестово покритие, 0 линт грешки, документация обновена.
2. **Security:** Нулева критична уязвимост (Snyk/OWASP) преди merge.
3. **Dependencies & Flow:** AUTH-1 → AUTH-2 → AUTH-3/4; AUTH-7 изисква завършен AUTH-3; AUTH-11 изисква AUTH-2.
