# 1.3: Хеширане на пароли и JWT токени

## Описание
Имплементиране на услуга за сигурно хеширане на пароли и генериране/потвърждаване на JWT токени.

## Функционалност

### PasswordService
- `hashPassword(password: string): Promise<string>`
  - Генерира сигурен хеш с Argon2id
  - Използва криптографски сигурна сол за всяка парола
  - Връща хеширана парола във формат: `$argon2id$v=19$m=65536,t=3,p=4$salt$hash`

- `verifyPassword(password: string, hash: string): Promise<boolean>`
  - Верифицира парола срещу хеш
  - Защитена срещу timing атаки

- `isPasswordStrong(password: string): { valid: boolean; message?: string }`
  - Проверява дали паролата отговаря на изискванията:
    - Минимум 12 символа
    - Поне една главна буква
    - Поне една малка буква
    - Поне една цифра
    - Поне един специален символ
    - Не съдържа потребителско име или имейл

- `isPasswordCompromised(password: string): Promise<boolean>`
  - Проверява дали паролата е била компрометирана чрез Have I Been Pwned API
  - Използва k-анонимност за повишена поверителност
  - Кешира резултатите за 24 часа

### JWT Service

#### Types
```typescript
interface JwtPayload {
  sub: string;        // User ID
  email: string;      // User email
  roles: string[];    // User roles
  iat: number;        // Issued at timestamp
  exp: number;        // Expiration timestamp
  jti?: string;       // JWT ID (optional)
  iss?: string;      // Issuer (optional)
  aud?: string | string[]; // Audience (optional)
}

interface TokenPair {
  accessToken: string;
  refreshToken: string;
  expiresIn: number;
  tokenType: string;
}
```

### JWT Service
- `generateAccessToken(user: User): string`
  - Издава JWT токен с 15 минути живот
  - Подписан с RSA ключ
  - Автоматично попълва claims от потребителския обект
  - Съдържа claims: sub, email, firstName, lastName, roles, iat, exp

- `generateRefreshToken(userId: string): Promise<string>`
  - Генерира случаен токен с 7 дни живот
  - Хешира токена преди запис в базата
  - Записва в `refresh_tokens` таблицата с userId и expiresAt
  - Връща plain текст токен за потребителя
  - Хвърля грешка при проблем с базата данни

- `verifyToken(token: string): Promise<JwtPayload>`
  - Валидира JWT токен и връща payload
  - Проверява дали токенът не е в blacklist
  - Валидира подписа и времето на изтичане
  - Хвърля грешка при изтекъл, невалиден или отнет токен
  - Връща декодирания payload при успех

## Конфигурация

### JWT Конфигурация
```env
# JWT Configuration
JWT_SECRET=your-secret-key
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
JWT_ISSUER=your-app-name
JWT_AUDIENCE=your-audience

# Argon2 параметри
ARGON2_TIME_COST=3
ARGON2_MEMORY_COST=65536
ARGON2_PARALLELISM=4
ARGON2_HASH_LENGTH=32
ARGON2_SALT_LENGTH=16

# JWT конфигурация
JWT_SECRET=your-256-bit-secret
JWT_EXPIRATION=15m
REFRESH_TOKEN_EXPIRATION_DAYS=7
```

## Критерии за приемане
- [ ] 90%+ покритие с unit тестове
- [ ] Време за хеширане < 300ms при 95-ти персентил
- [ ] Всички методи са защитени срещу timing атаки
- [ ] Интеграцията с Have I Been Pwned API работи коректно
- [ ] JWT токените се валидират правилно с публичния ключ

## Зависимости
- [AUTH-1-T1](AUTH-1-T1.md)

## Свързани файлове
- `src/auth/services/password.service.ts`
- `src/auth/services/jwt.service.ts`
- `test/auth/services/password.service.spec.ts`
- `test/auth/services/jwt.service.spec.ts`

## Сигурност
- Никога не логвайте пароли или токени в логовете
- Използвайте криптографски сигурни функции за генериране на случайни стойности
- Ограничете скоростта на опитите за угаждане на пароли
