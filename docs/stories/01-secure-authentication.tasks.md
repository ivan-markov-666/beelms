# Tasks – Epic 01: Secure Authentication

Този документ съдържа техническите задачи (tasks), необходими за реализиране на user story-тата от епика **„Сигурна автентикация и управление на потребители“**. Всеки task има:

- ID (напр. `AUTH-1-T1`)
- Описание
- Категория / Компонент
- Очакван резултат (Definition of Done)
- Зависимости

---

## AUTH-1 – Регистрация на нов потребител

**Сигурност и мониторинг:**
- Всички заявки се логват с X-Request-ID за проследяване
- Интеграция със Sentry за мониторинг на грешки и известия в реално време
- Rate limiting за защита срещу brute force атаки
- Одит логове за всички критични действия

**Сигурност на данните:**
- Криптиране на чувствителни данни (напр. имейл) с AES-256
- Хеширане на пароли с bcrypt/Argon2
- JWT токени с RSA ключове и механизъм за ротация
- Refresh токени съхранени в Redis с TTL

**Наблюдаемост:**
- Метрики за време на отговор, грешки и използване на ресурси
- Интеграция с Grafana за визуализация на метрики
- Аларми при необичаен трафик или грешки

**Документация:**
- Swagger/OpenAPI документация с примери и грешки
- GDPR съвместими съобщения за грешки
- Документирани rate limit-и и кодове за грешки
| Task ID | Описание | Компонент | DoD | Зависимости |
|---------|----------|-----------|-----|-------------|
| AUTH-1-T0 | Инициализация на NestJS проект (CLI) + базови конфигурации (TypeScript, ESLint, Prettier, Jest, JWT, TLS 1.3) | DevOps | `npm run start:dev` стартира без гречки, конфигуриран е HTTPS с TLS 1.3, време за стартиране ≤ 5s, интегриран Sentry за мониторинг | – |
| AUTH-1-T1 | Създаване/миграция на таблици `users`, `user_roles`, `verification_tokens` и `refresh_tokens` | DB | Миграциите се изпълняват без грешки, GDPR съвместими, инициализиране на роли | T0 |
| AUTH-1-T2 | Имплементация на service за хеширане на пароли (bcrypt/Argon2) и JWT токени | Backend | Юнит тест ≥ 90 % покритие, използване на уникални соли, конфигуриране на JWT, изпълнение p95 ≤ 300ms | T1 |
| AUTH-1-T3 | Endpoint `POST /registration` с валидация, i18n, rate limiting и observability | Backend | Интеграционен тест **201**, GDPR съвместимост, SLO метрики, rate limiting 100 заявки/мин | T2 |
| AUTH-1-T4 | Генериране на email-verification token + модел `verification_tokens` и Refresh токени | Backend, DB | Token TTL 24 h, миграция, валидация на токени, инвалидиране на токени при използване, логване на опити за верификация | T3 |
| AUTH-1-T5 | Имплементация на `EmailService` с i18n, observability и мониторинг | Infrastructure | Имейл мониторинг, SLO метрики, аларми, интеграция със Sentry, метрики за успешно изпратени имейли, грешки и време за изпращане | T4 |
| AUTH-1-T6 | Обновяване на OpenAPI (registration schema + examples) с i18n параметри | Docs | `npm run swagger` генерира валиден spec с i18n параметри, GDPR съвместимост, документация за rate limiting, кодове на грешки и примери | T3 |
| AUTH-1-T7 | Тестване на registration flow с i18n, observability и сигурност | Tests | ≥ 90 % unit, SLO метрики, аларми, pass CI, тестове за rate limiting, валидация на входни данни, сигурност и GDPR съвместимост | T3–T5 |

### Подробно описание на задачите за AUTH-1 – Регистрация и автентикация на потребител

#### Общи изисквания (приложими за всички задачи):
- Всички комуникации трябва да са криптирани с TLS 1.3
- Да се спазват изискванията на GDPR за защита на личните данни
- Всички пароли трябва да се съхраняват само в хеширан вид с bcrypt/Argon2
- Да се използват сигурни методи за генериране на токени с JWT + RSA
- Всички грешки трябва да са локализирани (поддръжка на български и английски език)
- Да се използват най-новите версии на библиотеките за сигурност
- Всички чувствителни конфигурационни параметри да се съхраняват в Vault
- Автоматично подновяване на SSL сертификати чрез LetsEncrypt
- Интеграция с система за мониторинг на изтичащи сертификати
- Автоматично скалиране при натоварване на автентикационните услуги
- Редовно тестване на процедурите за възстановяване от резервни копия
- Имплементиране на rate limiting за защита срещу brute force атаки
- Сигурно съхранение на сесии с Redis и автоматично изтичане
- Криптиране на чувствителни данни с AES-256 в базата данни
- Имплементиране на одит логове за всички критични действия
- Поддръжка на GDPR изисквания за изтриване и експорт на данни

## AUTH-2 – Потвърждение на имейл и управление на сесии

### Общи бележки:
- Всички ендпойнти изискват валиден JWT токен (освен публичните)
- Всички отговори трябва да включват подходящи HTTP хедъри за кеширане
- Да се използват HTTP статус кодове според REST стандартите
- Всички заявки трябва да са валидирани срещу CSRF токени
- Да се използва rate limiting за защита срещу злоупотреби
- Всички потребителски сесии трябва да се логват за целите на сигурността
- Да се използва Content Security Policy (CSP) за защита срещу XSS атаки
- Всички форми трябва да използват CSRF токени
- Да се използват сигурни бисквитки с флагове HttpOnly и Secure
- Всички URL адреси трябва да са сигурни и да не съдържат чувствителни данни

### Бележки за сигурност и GDPR:

#### Управление на пароли и токени
- Всички пароли трябва да отговарят на минималните изисквания за сложност (минимум 12 символа, главни/малки букви, цифри, специални символи)
- Да се използва bcrypt с работен фактор минимум 10 или Argon2 за хеширане на пароли
- Всички JWT токени трябва да се подписват с RSA ключ и да имат ограничен живот
- Refresh токените трябва да се съхраняват сигурно в Redis с TTL и да могат да бъдат отнети
- Да се използва key rotation за JWT ключовете

#### Защита на данните
- Всички лични данни трябва да се криптират с AES-256 в базата данни
- Да се използват подготвени заявки (prepared statements) за всички заявки към базата данни
- Да се извършва валидация и санитизиране на всички входни данни от потребители
- Да се използват сигурни настройки за сесиите (име, време на живот, обхват, secure, httpOnly, SameSite)
- Да се използват подходящи HTTP хедъри за сигурност (HSTS, X-Content-Type-Options, CSP, X-Frame-Options)

#### Логване и одит
- Всички критични действия трябва да се логват с пълна информация за аудит
- Логовете не трябва да съдържат чувствителни данни (пароли, токени, лични данни)
- Да се използва структурирано логване за по-лесна обработка и анализ
- Да се поддържат одит логове за всички промени в потребителските данни

#### Спазване на GDPR
- Да се предостави възможност за изтриване на всички лични данни при поискване
- Да се поддържа възможност за експорт на всички лични данни в четлив формат
- Да се съхраняват само необходимите данни и само за необходимото време
- Да се използват договори за обработване на данни (DPA) с всички доставчици на услуги
- Да се поддържа регистър на дейностите по обработване на лични данни

#### Защита срещу атаки
- Да се прилага rate limiting за всички публични ендпойнти
- Да се използва CSRF защита за всички форми и API ендпойнти
- Да се използва Content Security Policy (CSP) за защита срещу XSS атаки
- Да се извършват редовни тестове за сигурност (напр. с OWASP ZAP)
- Да се поддържа актуална документация за всички сигурностни мерки и процеси

## AUTH-2 – Потвърждение на имейл и управление на сесии
| Task ID | Описание | Компонент | DoD | Зависимости |
|---------|----------|-----------|-----|-------------|
| AUTH-2-T1 | Endpoint `GET /verify-email?token=` | Backend | Връща **200** и активира акаунта | AUTH-1-T4 |
| AUTH-2-T2 | Инвалидация/изтриване на използвани/изтекли токени | Backend, DB | Токен изчезва след use/TTL | T1 |
| AUTH-2-T3 | Front-end страница за успех/неуспех (placeholder) | Frontend | Показва статус | – |
| AUTH-2-T4 | Тестове (unit + integration) | Tests | CI зелено | T1–T2 |

## AUTH-3 – Вход с имейл и парола
| Task ID | Описание | Компонент | DoD | Зависимости |
|---------|----------|-----------|-----|-------------|
| AUTH-3-T1 | Service за издаване на JWT access + refresh токени | Backend | Подписани с RS256 | AUTH-2 |
| AUTH-3-T2 | Endpoint `POST /login` (HttpOnly cookies) | Backend | **200**, p95 ≤ 300 ms | T1 |
| AUTH-3-T3 | Съхранение на refresh токени (Redis/DB) | Infrastructure | Revocation работи | T1 |
| AUTH-3-T4 | Performance тест (k6) | QA | p95 ≤ 300 ms | T2 |
| AUTH-3-T5 | Тестове (unit+integration) | Tests | CI зелено | T2–T3 |

## AUTH-4 – Подновяване на сесия (refresh)
| Task ID | Описание | Компонент | DoD | Зависимости |
|---------|----------|-----------|-----|-------------|
| AUTH-4-T1 | Endpoint `POST /refresh` | Backend | Връща нов access, задава cookies | AUTH-3-T3 |
| AUTH-4-T2 | Revocation check за изтекли/блокирани refresh токени | Backend | Невалиден → **401** | T1 |
| AUTH-4-T3 | Тестове (unit+integration) | Tests | CI зелено | T1–T2 |

## AUTH-5 – Забравена парола
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-5-T1 | Endpoint `POST /forgot-password` генерира токен (TTL ≤30 min) | Backend | Връща **200** | AUTH-1 |
| AUTH-5-T2 | Endpoint `POST /reset-password` + валидация токен | Backend | Паролата сменена, токени инвалидирани | T1 |
| AUTH-5-T3 | Email шаблон за reset | Infra | Имейл получен | T1 |
| AUTH-5-T4 | Тестове (unit+integration) | Tests | CI зелено | T2 |

## AUTH-6 – Проверка на силата на пароли
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-6-T1 | Интеграция на `zxcvbn` за password strength | Backend | Weak → **400** | AUTH-1 |
| AUTH-6-T2 | Проверка срещу HaveIBeenPwned API | Backend | Pwned → **400** | T1 |
| AUTH-6-T3 | Тестове за слаб/компрометиран пароли | Tests | CI зелено | T1–T2 |

## AUTH-7 – RBAC (admin / student)
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-7-T1 | Дефиниция на enum `Role` + seed роли | Backend, DB | Enum наличен, seed script | AUTH-1 |
| AUTH-7-T2 | `RolesGuard` + `@Roles()` декоратор | Backend | Непозволен достъп → **403** | T1 |
| AUTH-7-T3 | Интеграционни тестове за защитени пътеки | Tests | 100 % покритие на guard | T2 |

## AUTH-8 – Seed скрипт за първи admin
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-8-T1 | CLI `npm run seed:admin` | DevOps | Скрипт идемпотентен | AUTH-7-T1 |
| AUTH-8-T2 | Документация в README | Docs | README секция „Seeding“ | T1 |
| AUTH-8-T3 | Интеграционен тест за скрипта | Tests | CI зелено | T1 |

## AUTH-9 – Логване на опити за вход
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-9-T1 | Structured logging (winston/pino) за `/login` | Backend | JSON + Sentry event | AUTH-3-T2 |
| AUTH-9-T2 | Филтри за успешно/неуспешно влизане | Backend | Логовете съдържат IP, UA, userId | T1 |
| AUTH-9-T3 | Тестове за логиране | Tests | CI зелено | T2 |

## AUTH-10 – Rate limiting на auth endpoints
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-10-T1 | Интеграция на rate-limiter (nestjs-rate-limiter) | Backend | 5 req/min → **429** | AUTH-3 |
| AUTH-10-T2 | Конфигурация чрез ENV | DevOps | Праг променяем без redeploy | T1 |
| AUTH-10-T3 | Тестове | Tests | CI зелено | T1 |

## AUTH-11 – Изтриване на акаунт (GDPR)
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-11-T1 | Endpoint `DELETE /me` (изисква email-confirm токен) | Backend | Връща **204** | AUTH-2 |
| AUTH-11-T2 | Логика за заличаване/анонимизиране на данни (≤30 дни) | Backend, DB | Данни изтрити | T1 |
| AUTH-11-T3 | Email шаблон за потвърждение | Infra | Имейл получен | T1 |
| AUTH-11-T4 | Тестове + GDPR log | Tests | CI зелено | T2 |

## AUTH-12 – OpenAPI спецификация
| Task ID | Описание | Компонент | DoD | Зависимости |
| AUTH-12-T1 | Конфигуриране на `@nestjs/swagger` | Backend | `swagger.json` генерирано | AUTH-3 |
| AUTH-12-T2 | CI стъпка за проверка на swagger diff | DevOps | Pipeline фейлва при breaking change | T1 |
| AUTH-12-T3 | Добавяне на описания/примери за всички auth модели | Docs | 100 % completeness | T1 |

---

### Dependencies Graph (високо ниво)
```
AUTH-1 → AUTH-2 → AUTH-3 → AUTH-4
            ↘
             AUTH-11
AUTH-3 → AUTH-10, AUTH-9, AUTH-12
AUTH-7 ← AUTH-3
AUTH-8 ← AUTH-7
```

### Definition of Done (global)
* ✅ Юнит/интеграционни тестове ≥ 90 % покритие
* ✅ 0 линт грешки
* ✅ Документация и OpenAPI актуализирани
* ✅ Нулева критична уязвимост (Snyk/OWASP)

---

> Поддържай задачите актуални. При промяна на изискванията, обнови този документ и отрази зависимостите.
