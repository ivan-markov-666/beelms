# Епик: Сигурна автентикация и управление на потребители

## Бизнес цел
Да предоставим сигурен, надежден и удобен за потребителя слой за автентикация, който позволява на студенти и администратори да използват LMS, като в същото време изгражда основа за бъдещи функционалности. Ранното интегриране на сигурността намалява преработките и увеличава доверието на потребителите.

## Метрики за успех / KPI
- Процент на грешки при автентикация < **0.1 %** (за последните 28 дни)
- 95-ти персентил време за вход ≤ **300 ms**
- Конверсия регистрация → потвърден email ≥ **70 %**
- Успешно възстановяване на парола ≥ **95 %** в рамките на 15 мин
- Нула критични уязвимости, свързани с автентикацията, преди продукционен запуск
- Успешно обработени заявки за изтриване на акаунт (GDPR Art. 17) ≥ **100 %** (измерено чрез CI e2e тестове)

## Основни изисквания
- **Регистрация**
  - Регистрация само с email и парола
  - Автоматично присвояване на роля `student`
  - Процес за потвърждение на email
- **Вход / Управление на сесии**
  - JWT access токени (15 мин) + refresh токени (7 дни)
  - Съхранение в HTTP-only защитени cookies
- **Възстановяване на парола**
  - Временни токени с ограничена валидност, изпратени по email
  - Проверка за сила на паролата и срещу бази данни с изтекли пароли
- **Контрол на достъпа (RBAC)**
  - Роли: `admin`, `student`, възможност за разширяване
  - Middleware в NestJS за защита на маршрути
- **Създаване на администратор**
  - CLI/seed скрипт за първия `admin` (не през публичен API)
- **Наблюдаемост и сигурност**
  - Структурирани логове за успешни/неуспешни опити (IP, UA) → dev Sentry & console
  - Rate-limiting и защита от brute-force (напр. Nest rate-limiter)
  - Unit и интеграционни тестове за всички auth потоци (>90 % покритие)
- **Документация и съответствие**
  - OpenAPI спецификация на auth endpoint-ите
  - GDPR съответствие: изтриване на данни и промяна на парола
  - API flow за изтриване на акаунт (“Right to be Forgotten”) с потвърждение по email и автоматично заличаване на лични данни в рамките на 30 дни

## Извън обхвата
- Социален логин (Google, Facebook и др.)
- Двуфакторна автентикация (MFA)
- Enterprise SSO / външни IdP интеграции

## Зависимости
- Таблица `users` в PostgreSQL и Redis за сесии/blacklist
- Имейл услуга (SendGrid sandbox / SMTP dev контейнер)
- Библиотеки NestJS Auth & Passport
- CI pipeline (GitHub Actions) за тестове и lint
- Docker-compose за локален стак

## Рискове и смекчаване
| Риск | Въздействие | Вероятност | Митигиране |
|------|-------------|------------|------------|
| Изтичане на токени | Високо | Средно | HTTP-only cookies, кратък TTL, ротация на refresh токени |
| Brute-force атаки | Високо | Високо | Rate-limiting, captcha след N неуспеха |
| Слаби пароли | Средно | Високо | Проверка със zxcvbn, breached-pw API |
| Недоставени имейли | Средно | Средно | Верифициран домейн, тестови имейли рано |

## График / Основни етапи
| Етап | Целева дата | Отговорник |
|------|-------------|------------|
| Схема за auth + DB миграции | Седмица 1 | Backend Dev |
| Регистрация и потвърждение на email | Седмица 1 | Backend Dev |
| Вход, refresh и RBAC middleware | Седмица 2 | Backend Dev |
| Възстановяване на парола и admin provisioning | Седмица 2 | Backend Dev |
| Тестов пакет и CI интеграция | Седмица 3 | QA / Dev |
| Документация и security review | Седмица 3 | PM + Sec |

> Оценена продължителност: **2–3 седмици**, готово за локален end-to-end демо.

## Governance & Periodic Reviews
- **Annual threat-model review & update** (виж `docs/security/threat-model.md` §6)
- **Semi-annual penetration test** с проследяване на remediation tasks
- **Quarterly audit** на auth логове и account security events
