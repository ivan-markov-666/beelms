# STORY-WS2-BE-AUTH-PROFILE-ACCOUNT – Профил, изтриване и експорт на акаунт (Auth API)

## Summary
Като **регистриран потребител** искам да мога да **прегледам основна информация за акаунта си, да го изтрия окончателно и да експортирам личните си данни**, за да упражня правата си по GDPR и да имам контрол върху профила си.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-4..6, §4.7 FR-CROSS-2).
- MVP Feature List – `docs/architecture/mvp-feature-list.md` (§2.4 Профил и управление на акаунта).
- System Architecture – `docs/architecture/system-architecture.md` (GDPR, управление на данни, Auth service).
- OpenAPI – `docs/architecture/openapi.yaml` (`GET /api/users/me`, `DELETE /api/users/me`, `POST /api/users/me/export`).
- MCP EPIC Map – `docs/backlog/MCP-EPIC-map.md` (EPIC-AUTH-ACCOUNTS, EPIC-CROSS-GDPR-LEGAL).

## Acceptance Criteria
- `GET /api/users/me`:
  - При валиден JWT токен API връща `200 OK` и информация за текущия потребител (имейл, дата на регистрация + други полета според PRD).
  - При липсващ/невалиден токен се връща `401 Unauthorized`.
- `DELETE /api/users/me` (закриване/изтриване на акаунта):
  - Изисква валиден JWT токен.
  - Реализира **единен flow** за „right to be forgotten“ – акаунтът и личните данни се изтриват/анонимизират, без възможност за възстановяване.
  - API прилага поне логиката за „двустепенно потвърждение“ на ниво бизнес правила (FE може да реализира реалните два диалога).
  - След успешното изтриване старите токени на потребителя стават невалидни (напр. чрез ревокация/blacklist или промяна на ключови полета).
- `POST /api/users/me/export` (експорт на лични данни):
  - Изисква валиден JWT токен.
  - При success API подготвя експорта на личните данни (формат по избор – JSON/архив) и връща или директен файл, или метаданни за сваляне.
  - Заявката изисква успешно преминаване през защитен механизъм (напр. reCAPTCHA), както е описано в PRD.
- GDPR/поведение:
  - Личните данни на изтрит потребител не трябва да се появяват в бъдещи заявки/метрики, освен в анонимизирана форма.

## Dev Tasks
- [ ] Имплементиране на `GET /api/users/me` с извличане на данни за текущия потребител от контекста/JWT.
- [ ] Имплементиране на `DELETE /api/users/me` с реална логика за изтриване/анонимизиране на данните в съответствие с GDPR.
- [ ] Имплементиране на `POST /api/users/me/export` с генерация на файл/отговор с личните данни и интеграция с anti-bot защита.
- [ ] Актуализиране на модели/миграции, ако са нужни допълнителни полета за GDPR/track-ване.
- [ ] Unit тестове за трите ендпойнта, покриващи нормални и гранични сценарии.
- [ ] (по избор) Интеграционни тестове за end-to-end поведение на изтриване/експорт.
- [ ] Ръчно тестване чрез Swagger UI/Postman и впоследствие през FE екраните за профил.

## Notes
- Тази story е в пряка връзка със `STORY-WS2-FE-AUTH-PROFILE-ACCOUNT`, която дефинира UX/flows за профил и управление на акаунта.
- Важно е да се координира поведението при изтриване на акаунт с други модули (напр. Wiki, Practical Env), за да не останат „висящи“ зависимости към изтрития потребител.
- Форматът на експортираните данни трябва да бъде достатъчно четим и структуриран, за да отговори на GDPR изискванията (JSON/CSV/архив), дори в минималния WS-2 вариант.
