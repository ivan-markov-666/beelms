# STORY-WS2-BE-AUTH-PROFILE-ACCOUNT – Профил, изтриване и експорт на акаунт (Auth API)

Status: Draft

## Summary
Като **регистриран потребител** искам да мога да **прегледам основна информация за акаунта си, да го изтрия окончателно и да експортирам личните си данни**, за да упражня правата си по GDPR и да имам контрол върху профила си.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-4..6, §4.7 FR-CROSS-2).
- MVP Feature List – `docs/architecture/mvp-feature-list.md` (§2.4 Профил и управление на акаунта).
- System Architecture – `docs/architecture/system-architecture.md` (GDPR, управление на данни, Auth service).
- OpenAPI – `docs/architecture/openapi.yaml` (`GET /api/users/me`, `DELETE /api/users/me`, `POST /api/users/me/export`, `PATCH /api/users/me`, `POST /api/users/me/change-password`).
- MCP EPIC Map – `docs/backlog/MCP-EPIC-map.md` (EPIC-AUTH-ACCOUNTS, EPIC-CROSS-GDPR-LEGAL).

## Acceptance Criteria
- `GET /api/users/me`:
  - При валиден JWT токен API връща `200 OK` и информация за текущия потребител (имейл, дата на регистрация + други полета според PRD).
  - При липсващ/невалиден токен се връща `401 Unauthorized`.
- `PATCH /api/users/me` (актуализиране на базова профилна информация):
  - При валиден JWT токен и валидни данни заявката позволява смяна на имейл адреса на потребителя.
  - Новият имейл трябва да е във валиден формат и да не е вече зает от друг акаунт; при конфликт се връща подходящ код/съобщение за грешка (напр. `400` или `409`), без да се разкриват детайли за други акаунти.
- `POST /api/users/me/change-password`:
  - Изисква валиден JWT токен и текущата парола на потребителя.
  - При валидна текуща парола и нова парола, която покрива минималните правила за сигурност (поне 8 символа, в съответствие с правилата при регистрация/forgot-reset), паролата се обновява (bcryptjs hash).
  - При грешна текуща парола или невалидна нова парола API връща подходяща грешка без да уточнява кое от условията е нарушено.
  - След успешна смяна на паролата системата обработва съществуващите токени на потребителя според избрания security подход (напр. ревокация/инвалидиране), в синхрон със System Architecture.
- `DELETE /api/users/me` (закриване/изтриване на акаунта):
  - Изисква валиден JWT токен.
  - Реализира **единен flow** за „right to be forgotten“ – акаунтът и личните данни се изтриват/анонимизират, без възможност за възстановяване.
  - API прилага поне логиката за „двустепенно потвърждение“ на ниво бизнес правила (FE може да реализира реалните два диалога).
  - След успешното изтриване старите токени на потребителя стават невалидни (напр. чрез ревокация/blacklist или промяна на ключови полета).
- `POST /api/users/me/export` (експорт на лични данни):
  - Изисква валиден JWT токен.
  - При success API подготвя експорта на личните данни (формат по избор – JSON/архив) и връща или директен файл, или метаданни за сваляне.
  - Заявката изисква успешно преминаване през защитен механизъм (напр. reCAPTCHA), както е описано в PRD.
- GDPR/поведение:
  - Личните данни на изтрит потребител не трябва да се появяват в бъдещи заявки/метрики, освен в анонимизирана форма.

## Dev Tasks
- [ ] Имплементиране на `GET /api/users/me` с извличане на данни за текущия потребител от контекста/JWT.
- [ ] Имплементиране на `PATCH /api/users/me` за актуализиране на базова профилна информация (поне email) с валидация и проверка за дублиран имейл.
- [ ] Имплементиране на `POST /api/users/me/change-password` с проверка на текущата парола, валидация на новата парола и обновяване на паролния hash.
- [ ] Имплементиране на `DELETE /api/users/me` с реална логика за изтриване/анонимизиране на данните в съответствие с GDPR.
- [ ] Имплементиране на `POST /api/users/me/export` с генерация на файл/отговор с личните данни и интеграция с anti-bot защита.
- [ ] Актуализиране на модели/миграции, ако са нужни допълнителни полета за GDPR/track-ване.
- [ ] Unit тестове за всички по-горе описани ендпойнти (GET, PATCH, change-password, DELETE, export), покриващи нормални и гранични сценарии, включително security правила (non-enumeration, валидация на парола, обработка на токени).
- [ ] Интеграционни тестове за end-to-end поведение на смяна на парола, изтриване и експорт на акаунт.
- [ ] Ръчно тестване чрез Swagger UI/Postman и впоследствие през FE екраните за профил.
 
## Test Scenarios

- **[INT-PA-1] Преглед на профил (`GET /api/users/me`)**
  - Заявка с валиден JWT → очакване: `200 OK` с профилни данни (поне email и дата на регистрация).
  - Заявка без/с невалиден JWT → очакване: `401 Unauthorized`.

- **[INT-PA-2] Актуализиране на email (`PATCH /api/users/me`)**
  - Валиден JWT + нов email в коректен формат, който не е зает → очакване: 200 и актуализиран email.
  - Нов email, който вече е зает от друг акаунт → очакване: 400/409 без разкриване на чужди акаунти.
  - Невалиден email формат → очакване: validation грешка.

- **[INT-PA-3] Смяна на парола (`POST /api/users/me/change-password`)**
  - Валиден JWT + правилна текуща парола + валидна нова парола (>=8 символа) → очакване: 200, bcryptjs hash е обновен, при нужда токените се ревокират според архитектурата.
  - Грешна текуща парола или невалидна нова парола → очакване: подходяща грешка без уточнение кое условие е нарушено.

- **[INT-PA-4] Изтриване на акаунт (`DELETE /api/users/me`)**
  - Валиден JWT → DELETE → очакване: 204/200 според имплементацията; акаунтът и личните данни са изтрити/анонимизирани според GDPR; последващи заявки с предишни токени се отхвърлят (напр. 401).
  - Проверка, че свързаните модули (напр. Wiki/Практическа среда) не показват лични данни за изтрития потребител (само анонимизирани/агрегирани).

- **[INT-PA-5] Експорт на лични данни (`POST /api/users/me/export`)**
  - Валиден JWT + успешно преминат anti-bot механизъм → очакване: 202/200 и директен файл или метаданни за download в съответствие с архитектурата.
  - Липсващ/невалиден JWT или fail-нал CAPTCHA → очакване: 401 или грешка за неуспешен anti-bot, без да се изпълнява експорт.

- **[UNIT-PA-1] Бизнес логика за GDPR операциите**
  - Unit тестове за: валидация на email, валидация на парола, коректно обновяване на паролния hash, коректна анонимизация/изтриване на данни и обработка на токени при delete/change-password.

## Notes
- Тази story е в пряка връзка със `STORY-WS2-FE-AUTH-PROFILE-ACCOUNT`, която дефинира UX/flows за профил и управление на акаунта.
- Важно е да се координира поведението при изтриване на акаунт с други модули (напр. Wiki, Practical Env), за да не останат „висящи“ зависимости към изтрития потребител.
- Форматът на експортираните данни трябва да бъде достатъчно четим и структуриран, за да отговори на GDPR изискванията (JSON/CSV/архив), дори в минималния WS-2 вариант.
