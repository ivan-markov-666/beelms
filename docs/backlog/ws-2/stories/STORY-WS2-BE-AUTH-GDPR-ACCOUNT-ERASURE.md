# STORY-WS2-BE-AUTH-GDPR-ACCOUNT-ERASURE – GDPR изтриване/анонимизиране на акаунт

Status: Done

## Summary
Като **регистриран потребител**, който иска да упражни правото си да бъде забравен (GDPR "right to be forgotten"), искам **бекендът да изтрива/анонимизира трайно акаунта ми и личните ми данни**, така че да не могат да бъдат възстановени, но същевременно да не чупят зависимите модули (Wiki, Practical Env и др.).

Това WS-2 BE story надгражда `STORY-WS2-BE-AUTH-PROFILE-ACCOUNT` и `DELETE /api/users/me` (soft delete чрез `active=false`) с по-строга GDPR логика за изтриване/анонимизация.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-5, §4.7 FR-CROSS-2 GDPR).
- System Architecture – `docs/architecture/system-architecture.md` (GDPR, управление на данни, Auth service, Data lifecycle).
- OpenAPI – `docs/architecture/openapi.yaml` (`DELETE /api/users/me`).
- WS-2 stories – `docs/backlog/ws-2/stories/STORY-WS2-BE-AUTH-PROFILE-ACCOUNT.md`.

## Acceptance Criteria
- При `DELETE /api/users/me`:
  - Личните данни на потребителя (`email`, парола и други идентифициращи полета) се **изтриват или анонимизират** така, че да не могат да бъдат възстановени през обикновени BE операции.
  - Потребителят не може да влезе отново със старите си креденшъли.
  - Зависимите модули (Wiki, Practical Env) не показват повече лични данни за този потребител; вместо това се използва анонимизиран идентификатор/"Anonymous" изглед.
  - Операцията е идемпотентна – повторно `DELETE /api/users/me` не чупи нищо и връща същия статус код (напр. `204`).
- Данните, които остават за отчетни/агрегирани цели, са **де-персонализирани** (напр. брояч на изтрити акаунти), без лични идентификатори.

## Dev Tasks
- [x] Дизайн на модел за анонимизация:
  - WS-2 използва **анонимизиране** (soft delete) – `active = false` + анонимизиран email (`deleted+<id>@deleted.qa4free.invalid`) и изчистване на всички полета, свързани с автентикация и имейл (паролен hash, верификационни токени, pending email, reset токени, email-change броячи).
- [ ] Добавяне на нужни полета към `User` (ако е необходимо):
  - `deletedAt: timestamp`.
  - евентуално `anonymized: boolean`.
- [ ] Миграции за новите полета (ако се въведат `deletedAt`/`anonymized` в бъдещ lifecycle/audit story).
- [x] Обновяване на `AccountService.deleteAccount`:
  - да анонимизира `email` и `passwordHash` и да изчиства всички свързани имейл/парола токени и броячи;
  - да поддържа идемпотентност при повторно извикване (ако потребителят вече е неактивен или липсва, операцията връща `204` без грешка).
- [ ] Обновяване на други модули, които реферират `User`:
  - Wiki articles / contributions и др. да не показват реален email/име, а анонимен маркер – **извън обхвата на настоящия WS-2**, тъй като такива зависимости все още не са въведени.
- [x] Обновяване на `/users/me/export`, така че за вече изтрит/анонимизиран акаунт:
  - да връща подходяща грешка (в WS-2: `404` при `active=false`).
- [x] Unit тестове за новата логика за анонимизация (вкл. идемпотентност) в `AccountService`.
- [ ] E2E / integration тест(ове) за целия delete/анонимизиращ flow – могат да бъдат добавени върху WS-2 regression suite в бъдещ етап.

## Test Scenarios
- **[INT-GDPR-DEL-1] Пълно изтриване/анонимизиране**
  - Сценарий:
    - Регистрация и login → взимане на токен.
    - `DELETE /api/users/me` → очакване `204`.
    - Проверка в БД: личните данни са анонимизирани/изтрити според дизайна.
    - `POST /api/auth/login` със старите креденшъли → `401`.
    - `GET /api/users/me` → `404` или друга договорена грешка.
- **[INT-GDPR-DEL-2] Влияние върху зависими модули**
  - Сценарий:
    - Потребител създава съдържание (напр. Wiki action, когато има такъв flow).
    - След `DELETE /api/users/me`:
      - Съдържанието остава, но без лични данни (показва се като "Anonymous" / анонимен автор).
- **[INT-GDPR-DEL-3] Идемпотентност**
  - Повторен `DELETE /api/users/me` → същият или допустим статус код (напр. `204`), без грешка.

## Notes
- Конкретният подход (hard delete vs. анонимизация) трябва да бъде съгласуван с PRD и Legal/GDPR изискванията.
- Важно е да се избягва "висящо" съдържание, което реферира невалиден `userId` – поради това анонимизацията често е по-подходяща от пълно изтриване на реда.
