# STORY-WS2-BE-AUTH-EMAIL-VERIFICATION – Потвърждение на имейл при регистрация и смяна на имейл (Auth API)

Status: Done

## Summary
Като **новорегистриран потребител** и като **потребител, който сменя имейл адреса си**, искам **да потвърдя имейл адреса си чрез линк в имейл**, за да се гарантира, че имейлът е реален и че аз контролирам пощенската кутия.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-1, FR-AUTH-4, §4.7 FR-CROSS-2).
- MVP Feature List – `docs/architecture/mvp-feature-list.md` (§2.1 Регистрация, §2.4 Профил и управление на акаунта).
- System Architecture – `docs/architecture/system-architecture.md` (GDPR, управление на данни, Имейл услуга, "Потвърждение по имейл преди изтриване").
- OpenAPI – `docs/architecture/openapi.yaml` (ще бъде разширен с endpoints за email verification).

## Acceptance Criteria
- Регистрация:
  - `POST /api/auth/register` създава акаунт в състояние `unverified` (или еквивалентно поле), изпраща имейл с verification линк (токен).
  - Докато имейлът не е потвърден:
    - потребителят може да влиза (MVP вариант) **или** login е ограничен до минимален период – поведението се уточнява в System Architecture/PRD за сигурност;
    - не се изпращат чувствителни нотификации към непотвърдени имейли.
  - Когато потребителят отвори verification линка (`GET/POST /api/auth/verify-email?token=...`):
    - при валиден, неизтекъл токен имейлът се маркира като потвърден (`verified = true`);
    - при невалиден/изтекъл токен се връща подходяща грешка и не се променя състоянието на акаунта.
- Смяна на имейл (`PATCH /api/users/me`):
  - При заявка за промяна на имейл се създава заявка за верификация към новия адрес (verification token), но **старият имейл остава активен**, докато новият не бъде потвърден.
  - Потвърждение на новия email през verification линк → основният имейл на акаунта се сменя на новия, старият престава да се използва; при невалиден/изтекъл токен – без промяна.
- Security / GDPR:
  - Verification токените имат разумен срок на валидност (напр. 24 часа) и се съхраняват по сигурен начин.
  - Не се разкрива дали даден имейл съществува в системата (non-enumeration) – съобщенията при заявка за verification са общи.

## Dev Tasks
- [x] Дизайн на модел за състояние на имейла (`verified`, pending verification, токени, срок на валидност).
- [x] Добавяне на нужните полета към `User` и/или отделна таблица за verification токени.
- [x] BE endpoints за:
  - създаване и изпращане на verification токен при регистрация;
  - създаване и изпращане на verification токен при смяна на имейл;
  - потвърждение на токена (`/api/auth/verify-email` или еквивалентен endpoint).
- [x] Интеграция с имейл услугата (изпращане на имейли с линк за потвърждение).
- [x] Unit тестове за логиката за създаване/валидиране/изтичане на токени.
- [x] Интеграционни тестове за регистрация + verify, смяна на имейл + verify.

## Test Scenarios
- **[INT-EMAIL-1] Регистрация + потвърждение на имейл**
  - Регистрация с нов имейл → очакване: акаунт в състояние `unverified` + изпратен verification имейл.
  - Отваряне на линка → очакване: акаунтът става `verified`.
- **[INT-EMAIL-2] Регистрация с вече съществуващ имейл**
  - Регистрация с email, който вече е потвърден в друг акаунт → очакване: `409`/`400` според съществуващото поведение за duplicate email.
- **[INT-EMAIL-3] Смяна на имейл + потвърждение**
  - Потребител сменя имейла през `PATCH /api/users/me` → очакване: verification имейл към новия адрес; старият остава активен до потвърждение.
  - При потвърждение на новия имейл основният email в профила се сменя на новия.
- **[INT-EMAIL-4] Невалиден/изтекъл verification токен**
  - Потвърждение с невалиден или изтекъл токен → очакване: грешка; акаунтът и email-ът не се променят.

## Notes
- Това story допълва WS-2 Auth/Profile и Forgot/Reset stories и може да бъде реализирано поетапно (напр. първо само за регистрация, после за смяна на имейл).
- Детайлите за UX (копие на текстовете в имейла и екраните след потвърждение) се описват в отделно FE story (`STORY-WS2-FE-AUTH-EMAIL-VERIFICATION`).
