# STORY-WS2-FE-AUTH-PROFILE-ACCOUNT – UI за профил, изтриване и експорт на акаунт

Status: Done

## Summary
Като **регистриран потребител** искам да имам **екран „Моят профил“**, където мога да видя основна информация за акаунта си, да го изтрия и да заявя експорт на личните си данни, за да упражнявам правата си по GDPR.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-4..6, §4.7 FR-CROSS-2).
- MVP Feature List – `docs/architecture/mvp-feature-list.md` (§2.4 Профил и управление на акаунта).
- UX Design – `docs/ux/qa4free-ux-design.md` (екран „Моят профил“ и GDPR flows).
- User Flows – `docs/ux/flows/qa4free-user-flows.md` (flows за account delete и data export).
- System Architecture – `docs/architecture/system-architecture.md` (GDPR, Auth, frontend навигация).
- MCP EPIC Map – `docs/backlog/MCP-EPIC-map.md` (EPIC-AUTH-ACCOUNTS, EPIC-CROSS-GDPR-LEGAL).

## Acceptance Criteria
- Страница `/profile`:
  - Достъпна е само за вписани потребители; при липсващ/невалиден токен потребителят се пренасочва към `/auth/login`.
  - Показва основна профилна информация (имейл, дата на регистрация и др. според PRD).
  - Предоставя UI за промяна на имейл адреса (линк/бутон „Промяна“ до email реда), който отваря форма с валидация и извиква `PATCH /api/users/me`. Успешната смяна обновява показания имейл и показва съобщение за успех, а при грешка се показва подходящо съобщение без да се разкрива дали даден имейл вече е зает.
  - Когато BE връща флагове за лимит на смяна на email (напр. `emailChangeLimitReached`, `emailChangeLimitResetAt`), UI визуализира ясно предупреждение, че е достигнат максималният брой потвърждения за последните 24 часа, както и ориентировъчен момент, в който лимитът ще бъде нулиран.
  - Предоставя UI за смяна на паролата (линк/бутон „Промяна“ до реда за парола), който показва форма с текуща парола, нова парола и потвърждение. Формата валидира минималните изисквания (поне 8 символа и съвпадение на новата/потвърдена парола) на client-side и извиква `POST /api/users/me/change-password`. При success се показва съобщение за успех, а при грешка – общо съобщение без да се разкриват детайли.
  - Предоставя ясно достъпно действие "Изход" (logout), което изчиства локалното Auth състояние (JWT/сесия) и връща потребителя към подходящ публичен екран (напр. начална страница или Wiki), без да изисква отделен backend logout endpoint.
- Изтриване на акаунт:
  - На страницата има ясно обозначено действие за закриване/изтриване на акаунта.
  - UX реализира **двустепенно потвърждение** (два диалога/стъпки преди окончателно изтриване), в съответствие с PRD.
  - При потвърдено изтриване се вика `DELETE /api/users/me` и при успех потребителят се изписва и получава подходящо съобщение.
- Експорт на лични данни:
  - На страницата има действие „Експорт на лични данни“.
  - При заявка се вика `POST /api/users/me/export` (с нужните защити – напр. reCAPTCHA, ако UX/BE го изискват).
  - След успех потребителят може да свали файл или да получи ясна индикация за готовност на данните, според договореното API поведение.
- Общи UX изисквания:
  - Съобщенията за изтриване/експорт са ясни по отношение на последствията (без връщане след delete).
  - Екранът използва общ layout и UI компоненти и е в тон с останалия интерфейс.

## Dev Tasks
- [x] Имплементиране на страница `/profile` с извличане и визуализиране на данните от `GET /api/users/me`.
- [x] Имплементиране на UI за промяна на email адреса и интеграция с `PATCH /api/users/me` (валидиране, показване на съобщения за успех/грешка).
- [x] Имплементиране на UI за смяна на паролата (текуща/нова/потвърждение) и интеграция с `POST /api/users/me/change-password`.
- [x] Имплементиране на двустепенно потвърждение за изтриване на акаунта и интеграция с `DELETE /api/users/me`.
- [x] Имплементиране на UI за заявка за експорт на данни и интеграция с `POST /api/users/me/export`.
- [x] Guard-ване/redirect логика, така че неавторизирани потребители да не достъпват `/profile`.
- [x] Имплементиране на logout действие (бутон/линк), което изтрива локалните токени/сесия и пренасочва потребителя към публичен екран, в синхрон с `EPIC-WS2-AUTH-FE`.
- [x] Ръчно тестване на основните сценарии (view profile, delete account, export data).
- [ ] FE тестове за профилния екран и критичните действия.

## Test Scenarios

- **[FE-PR-1] View profile – авторизиран/неавторизиран потребител**
  - Авторизиран потребител отваря `/profile` с валиден токен → очакване: визуализирани са профилни данни (email, дата на регистрация и др.).
  - Потребител без или с невалиден токен → очакване: redirect към `/auth/login`.

- **[FE-PR-2] Смяна на email (`PATCH /api/users/me`)**
  - Валиден нов email (коректен формат, незает) → очакване: успешен отговор от BE; UI обновява показания email и показва success съобщение.
  - Невалиден формат или вече зает email → очакване: формата показва подходящо съобщение за грешка, без да разкрива детайли за други акаунти.

- **[FE-PR-3] Смяна на парола (`POST /api/users/me/change-password`)**
  - Въведени са текуща парола, валидна нова парола (>=8 символа) и потвърждение, което съвпада → очакване: при 200 UI показва success съобщение и може да нулира полетата.
  - Client-side: твърде къса нова парола или несъвпадение между нова/потвърдена → очакване: няма request към BE, показват се validation грешки под полетата.
  - Server-side: грешна текуща парола или невалидна нова парола според BE → очакване: общо съобщение за грешка, без да се уточнява кое условие е нарушено.

- **[FE-PR-4] Изтриване на акаунт (`DELETE /api/users/me`)**
  - Потребителят стартира delete действие → UX показва първи диалог за потвърждение; при потвърждение – втори, по-категоричен диалог; след второ потвърждение се изпраща `DELETE /api/users/me`.
  - При success: потребителят се изписва (локалното Auth състояние се чисти) и вижда ясно съобщение за окончателно изтриване; няма достъп до защитени екрани.

- **[FE-PR-5] Експорт на лични данни (`POST /api/users/me/export`)**
  - Потребителят кликва „Експорт на лични данни“ → изпраща се заявка към `POST /api/users/me/export` (с reCAPTCHA, ако е активна); при успех UI показва ясно съобщение и/или линк/бутон за сваляне на файла.
  - При грешка (напр. fail-нала CAPTCHA или сървърна грешка) → очакване: общо съобщение за грешка без технически детайли; потребителят може да опита отново.

- **[FE-PR-6] Logout**
  - Клик върху „Изход“ → локалните токени/сесия се изтриват; потребителят се пренасочва към публичен екран (начална страница или Wiki); повторен достъп до `/profile` води до redirect към `/auth/login`.

## Notes
- Тази story стъпва директно върху `STORY-WS2-BE-AUTH-PROFILE-ACCOUNT` и трябва да следи неговите API договори и GDPR изисквания.
- Важно е UX текстовете да са внимателно формулирани за GDPR (особено при изтриване и експорт на данни).
- В бъдещи WS може да се разшири екранът с допълнителни настройки (езикови предпочитания, нотификации и др.), но за WS-2 целта е минимален, но пълен GDPR/профил skeleton.
- Текущата имплементация добавя и лек client-side throttle за повтарящи се заявки за смяна на имейл към един и същ адрес (напр. в рамките на 60 секунди), за да намали риска от случайно изпращане на множество verification линкове към един и същ получател.
