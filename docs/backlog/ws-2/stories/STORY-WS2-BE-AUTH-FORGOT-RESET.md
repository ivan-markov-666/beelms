# STORY-WS2-BE-AUTH-FORGOT-RESET – Забравена парола и ресет (Auth API)

## Summary
Като **краен потребител** искам да мога да **заявя възстановяване на паролата си и да я сменя чрез сигурен линк/токен**, за да имам достъп до акаунта си дори ако съм забравил текущата парола.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-3, FR-AUTH-7).
- MVP Feature List – `docs/architecture/mvp-feature-list.md` (§2.3 Забравена парола).
- System Architecture – `docs/architecture/system-architecture.md` (email service, security, GDPR секция).
- OpenAPI – `docs/architecture/openapi.yaml` (`POST /api/auth/forgot-password`, `POST /api/auth/reset-password`).
- MCP EPIC Map – `docs/backlog/MCP-EPIC-map.md` (EPIC-AUTH-ACCOUNTS, EPIC-CROSS-SECURITY).

## Acceptance Criteria
- `POST /api/auth/forgot-password`:
  - При подаден имейл (валиден адрес), ако в системата съществува потребител с такъв имейл, се генерира reset токен с ограничен срок на валидност (напр. 24 часа) и се изпраща имейл с линк.
  - Отговорът към клиента е „success“ дори ако потребител с такъв имейл не съществува (за да не се разкриват регистрирани имейли).
  - Анти-bot защита (напр. reCAPTCHA) е активна за този ендпойнт.
- `POST /api/auth/reset-password`:
  - При валиден и неизтекъл токен и валидна нова парола:
    - Паролата на потребителя се обновява (bcryptjs hash).
    - Reset токенът става невалиден (еднократна употреба).
    - API връща `200 OK` и общо съобщение за успех.
  - При невалиден или изтекъл токен:
    - API връща подходящ код/съобщение (напр. `400`/`410`), без да разкрива излишна информация.
    - Поведението следва описаното в PRD (потребителят трябва да заяви нов forgot flow).
- Security/поведение:
  - Reset токените са криптографски сигурни и не могат да бъдат лесно отгатнати.
  - Логовете не съдържат токени или нови пароли в raw вид.

## Dev Tasks
- [ ] Имплементиране на `POST /api/auth/forgot-password` с генериране на reset токени и интеграция с имейл услуга (или mock в dev).
- [ ] Имплементиране на `POST /api/auth/reset-password` с валидация на токени, смяна на парола и инвалидиране на токена.
- [ ] Конфигуриране на срок на валидност на токените (напр. 24 часа) според PRD.
- [ ] Интеграция с anti-bot механизъм (напр. reCAPTCHA) за forgot-password заявките.
- [ ] Unit тестове за генериране и валидация на токени, промяна на парола и гранични случаи.
- [ ] (по избор) Интеграционни тестове, покриващи целия forgot/reset flow.
- [ ] Ръчно тестване чрез Postman/Swagger и, на по-късен етап, през FE формите.

## Notes
- Тази story е в пряка връзка със `STORY-WS2-FE-AUTH-FORGOT-RESET`, която описва UI/UX флоу за забравена и ресет парола.
- В dev среда може да се използва подход, при който reset линкът се логва в конзолата/файл вместо да се изпраща реален имейл, но DoD за production трябва да покрива реална имейл интеграция.
- Добре е да се помисли за ограничаване на честотата на forgot заявки от един и същ IP/имейл (rate limiting), за да се намали рискът от злоупотреби.
