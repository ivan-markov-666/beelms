# STORY-WS2-BE-AUTH-REGISTER-LOGIN – Регистрация и вход (Auth API)

Status: Done

## Summary
Като **краен потребител** искам да мога да се **регистрирам и вписвам** в платформата чрез имейл и парола, за да имам личен акаунт и достъп до функционалности, изискващи идентификация.

## Links to BMAD artifacts
- PRD – `docs/product/prd.md` (§4.2 FR-AUTH-1, FR-AUTH-2, FR-AUTH-7).
- MVP Feature List – `docs/architecture/mvp-feature-list.md` (§2.1 Регистрация, §2.2 Вход/Изход).
- System Architecture – `docs/architecture/system-architecture.md` (Auth service, JWT, security).
- OpenAPI – `docs/architecture/openapi.yaml` (`POST /api/auth/register`, `POST /api/auth/login`).
- MCP EPIC Map – `docs/backlog/MCP-EPIC-map.md` (EPIC-AUTH-ACCOUNTS, EPIC-CROSS-SECURITY).

## Acceptance Criteria
- `POST /api/auth/register`:
  - Съществува ендпойнт за регистрация, приемащ имейл и парола (и евентуално допълнителни полета според PRD).
  - При валидни данни се създава нов потребител в базата, с парола, съхранена като bcryptjs hash.
  - При вече зает имейл се връща подходящ код/съобщение за грешка (напр. `400` или `409`).
  - При невалидни данни (къса парола, невалиден имейл и др.) се връщат ясни validation грешки.
  - Анти-bot защита: заявката изисква успешно преминаване през защитен механизъм (напр. reCAPTCHA), както е описано в PRD.
- `POST /api/auth/login`:
  - Съществува ендпойнт за вход, приемащ имейл и парола.
  - При валидни креденшъли API връща `200 OK` и JWT токен (и/или refresh token, ако архитектурата го изисква), в съответствие с OpenAPI.
  - При невалидни креденшъли се връща `401 Unauthorized` без изтичане на информация (напр. „invalid credentials“ без уточнение кое поле е грешно).
  - Security/поведение:
  - JWT токените използват конфигурируема тайна и разумен срок на валидност.
  - Няма логиране на пароли в raw вид.

## Dev Tasks
- [x] Имплементиране на `POST /api/auth/register` с валидация, bcryptjs hashing и обработка на дублиран имейл.
- [x] Имплементиране на `POST /api/auth/login` с проверка на креденшъли и издаване на JWT токен.
- [x] Конфигуриране на JWT (секрет, валидност, payload), в синхрон със System Architecture.
- [x] Интеграция с anti-bot механизъм (напр. reCAPTCHA) за регистрация (BE hook с `AUTH_REQUIRE_CAPTCHA` + `captchaToken`).
- [x] Unit тестове за основната бизнес логика (register/login, validation, JWT issuance).
- [x] Интеграционни тестове за Auth ендпойнтите срещу test база.
- [x] Ръчно тестване / верификация чрез автоматичните e2e тестове и ръчни заявки към API (успешна регистрация, неуспешна регистрация, успешен/неуспешен вход).
 
## Test Scenarios

- **[INT-RL-1] Регистрация – успешен сценарий (`POST /api/auth/register`)**
  - Вход: валиден email + валидна парола (според минималните правила за сигурност) + успешно преминат anti-bot механизъм.
  - Очакване: 201/200 според имплементацията; създаден е нов потребител с парола, съхранена като bcryptjs hash; не се връща паролата в отговора.

- **[INT-RL-2] Регистрация – дублиран email**
  - Вход: email, който вече е регистриран.
  - Очакване: 400/409 с подходящо съобщение за грешка; няма създаден втори акаунт; не се разкриват детайли за съществуващия акаунт извън необходимото.

- **[INT-RL-3] Регистрация – невалидни данни**
  - Вход: невалиден email формат и/или твърде къса парола.
  - Очакване: 400 с ясни validation грешки за съответните полета; не се създава акаунт.

- **[INT-RL-4] Вход – успешен сценарий (`POST /api/auth/login`)**
  - Вход: валиден email + правилна парола за съществуващ акаунт.
  - Очакване: 200 OK и издаден JWT токен (и/или refresh token според архитектурата), в съответствие с OpenAPI; няма логиране на паролата в raw вид.

- **[INT-RL-5] Вход – невалидни креденшъли**
  - Вход: грешен email или грешна парола.
  - Очакване: 401 Unauthorized с общо съобщение за грешка (напр. "invalid credentials"), без да се уточнява кое поле е грешно; не се издава JWT.

- **[INT-RL-6] Регистрация – anti-bot hook (`AUTH_REQUIRE_CAPTCHA`)**
  - Вход: `AUTH_REQUIRE_CAPTCHA='true'`, заявка без `captchaToken`, последвана от заявка със `captchaToken` и валидни данни.
  - Очакване: първата заявка връща `400 Bad Request` с общо съобщение за грешка; втората заявка завършва успешно (`201`) и създава акаунт.

- **[INT-RL-7] Валидация на излишни полета / защита срещу over-posting**
  - Вход: тяло с валидни `email` и `password`, но и допълнително непознато поле.
  - Очакване: `400 Bad Request` от `ValidationPipe` (`forbidNonWhitelisted: true`); в отговора не се връщат чувствителни полета (`password`, `passwordHash`).

- **[UNIT-RL-1] Бизнес логика за регистрация и вход**
  - Unit тестове за: валидация на входните данни при регистрация (email/парола), правилно хеширане на паролата с bcryptjs, проверка на парола при вход, коректно издаване/конфигуриране на JWT токени и поведение на anti-bot hook-a (`AUTH_REQUIRE_CAPTCHA`).

## Notes
- Тази story е в тясна връзка със `STORY-WS2-FE-AUTH-REGISTER-LOGIN`, която дефинира UI флоу за register/login.
- Необходимо е да се използва `bcryptjs` (а не native `bcrypt`) за съвместимост с Windows и CI средата.
- Добре е отговорите на API да са оформени така, че да не разкриват излишна информация при грешки (особено при вход), в съответствие с security препоръките.
