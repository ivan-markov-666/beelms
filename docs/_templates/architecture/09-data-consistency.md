# Консистентност на данните и разпределени транзакции

## Защо е важно
В микросервизна архитектура поддържането на целостта на данните между услугите е критично. Този документ описва моделите, които ще използваме.

## Модели

### 1. Saga (Сага) модел
*Дълготрайни транзакции, координирани чрез събития.*
- Оркестратор: оркестраторен сървис, базиран на `@nestjs/event-emitter`.
- Локални транзакции във всеки сервис чрез TypeORM транзакции.

### 2. Двуетапно потвърждение (2PC)
*Запазено за критични междусервисни операции (напр. плащане + записване; **опционално, не се използва в текущата версия**).* Координаторът е имплементиран с библиотеката `node-sagas`. Използвайте само когато идемпотентността не може да реши проблема.

### 3. Идемпотентни ключове
Всички крайни точки за запис приемат хедър `Idempotency-Key`.

### 4. Нива на изолация
| Сервис | Изолация | Обосновка |
|---------|-----------|-----------|
| Auth    | READ COMMITTED | Производителност |
| Payments (бъдещо)| SERIALIZABLE   | Финансова коректност (за бъдещи платени функции) |

## Откази и повторения
- Outbox модел с PostgreSQL → RabbitMQ.

## Референции
- Крис Ричардсън – Microservice Patterns
